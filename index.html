<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- Update these Coloris links to the latest version -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.css"/>
  <script src="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.js"></script>
  
  <!-- Add Summernote dependencies -->
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
  
  <style>
    /* Add these CSS variables at the start of the style section */
    :root {
      --bg-color: #f4f4f4;
      --text-color: #000000;
      --card-bg: #ffffff;
      --item-bg: #e9ecef;
      --item-hover: #dee2e6;
      --border-color: #ddd;
      --header-bg: #f8f9fa;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --card-bg: #2d2d2d;
      --item-bg: #3d3d3d;
      --item-hover: #4d4d4d;
      --border-color: #404040;
      --header-bg: #2a2a2a;
    }

    .editable {
      border: none;
      outline: none;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      font-size: 16px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .container {
      padding: 15px;
    }

    .top-menu {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 10px;
    }

    .top-menu button {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .projects-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .project {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      background-color: var(--card-bg);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .project-header .editable {
      cursor: pointer;
      border: none;
      background-color: transparent;
      font-size: 1.2em;
      padding: 5px;
      outline: none;
      transition: border-bottom 0.2s;
    }

    .lists-container {
      display: flex;
      gap: 15px;
    }

    .highlight {
      background-color: #f0f8ff;
    }

    .list {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--card-bg);
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;  /* Add this to prevent corner gaps */
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--header-bg);
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      gap: 5px;
      position: relative; /* For absolute positioning of rearrange buttons */
    }

    .list-header .rearrange-buttons {
      display: flex;
      gap: 5px;
    }

    .list-items {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .list-item {
      background-color: var(--item-bg);
      padding: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
      cursor: move;
      /* Indicates draggable items */
      position: relative;  /* For positioning the hover menu */
    }

    .list-item:hover {
      background-color: var(--item-hover);
    }

    .drop-highlight {
      /* Highlight effect when an item is over this area */
      background-color: #f0f8ff;
    }

    .list-item.todo-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .list-item.todo-item .item-name {
      flex: 1;
    }

    .list-item.todo-item .item-name.strikethrough {
      text-decoration: line-through;
      color: gray;
    }

    .add-item-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .add-item {
      cursor: pointer;
      background: none;
      text-align: center;
      padding: 10px;
      border: dashed 1px;
      border-radius: 5px;
      color: #6c757d;
      flex: 1;
    }

    .add-item:hover {
      background-color:var(--item-hover);
    }

    .add-list {
      cursor: pointer;
      background: none;
      text-align: center;
      padding: 10px;
      border: dashed 1px;
      border-radius: 5px;
      color: #6c757d;
    }

    .add-list:hover {
      background-color: var(--item-hover);;
    }

    .dragging {
      opacity: 0.5;
      cursor: move;
    }

    .drop-placeholder {
      height: 2px;
      background-color: #555555;
      margin: 10px 0;
      transition: all 0.2s ease;
      position: relative;
    }

    .drop-placeholder::before {
      content: '';
      position: absolute;
      left: -5px;
      top: -4px;
      width: 10px;
      height: 10px;
      background-color: #555555;
      border-radius: 50%;
    }

    .drop-placeholder::after {
      content: '';
      position: absolute;
      right: -5px;
      top: -4px;
      width: 10px;
      height: 10px;
      background-color: #555555;
      border-radius: 50%;
    }

   .list-items {
      min-height: 50px;
      /* Ensure empty lists have drop area */
      padding: 10px;
    }

    .list-item.shift-up {
      transform: translateY(-100%);
      transition: transform 0.2s ease;
    }

    .list-item.shift-down {
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }

    .delete-confirm:hover {
      background-color: #000 !important;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }

      100% {
        opacity: 1;
      }
    }

    /* Custom checkbox styling */
    .todo-checkbox {
      accent-color: #28a745;  /* Green color for checked state */
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .list-item button {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .list-item:hover button {
      opacity: 1;
    }

    /* Add style for theme toggle button */
    #themeToggleBtn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #themeToggleBtn:hover {
      background-color: #000;
    }

    [data-theme="dark"] #themeToggleBtn:hover {
      background-color: #666;
    }

    /* Update hover menu styles */
    .item-hover-menu {
      position: absolute;
      top: -20px;
      right: 10px;
      background-color: var(--card-bg);
      padding: 3px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: none;  /* Change from flex to none */
      gap: 5px;
      z-index: 100;
      align-items: center;
    }

    /* Add hover state to show menu */
    .list-item:hover .item-hover-menu {
      display: flex;  /* Show menu on hover */
    }

    /* Hide the color input completely */
    .item-hover-menu input[data-coloris] {
      position: absolute;
      visibility: hidden;
      width: 0 !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      border: none !important;
      pointer-events: none;
      opacity: 0;
    }

    .item-hover-menu button {
      padding: 3px 6px;
      background-color: var(--item-bg);
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }

    .item-hover-menu button:hover {
      background-color: var(--item-hover);
    }

    .item-hover-menu button i {
      font-size: 14px;
    }

    /* Override any Coloris default styles */
    .item-hover-menu button[data-coloris] {
      padding: 3px 6px !important;
      width: 28px !important;
      height: 28px !important;
      background-color: var(--item-bg) !important;
    }

    /* Remove the old add-list styles */
    .add-list {
      display: none; /* Hide the old add list div */
    }

    /* Add style for the new add list button */
    .add-list-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .add-list-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .add-list-btn:hover {
      background-color: #666;
    }

    /* Add standardized button styles */
    .project-header button,
    .list-header button {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;  /* Set fixed width */
      height: 32px; /* Set fixed height */
      margin-left: 5px;
      transition: width 0.2s ease; /* Add smooth transition for width changes */
    }

    /* Add style for delete confirmation state */
    .project-header button.delete-confirm,
    .list-header button.delete-confirm {
      width: auto; /* Allow width to adjust to content */
      padding: 5px 10px; /* Add some padding for the text */
    }

    .project-header button:hover,
    .list-header button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .project-header button:hover,
    [data-theme="dark"] .list-header button:hover {
      background-color: #666;
    }

    /* Remove individual button styles that might conflict */
    .add-list-btn,
    .collapse-btn,
    #themeToggleBtn {
      /* Remove any specific padding/size styles */
    }

    /* Ensure icons are centered */
    .project-header button i,
    .list-header button i {
      font-size: 14px; /* Standardize icon size */
    }

    .list.dragging {
      opacity: 0.5;
      cursor: move;
    }

    /* Update top menu button hover styles */
    .top-menu button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .top-menu button:hover {
      background-color: #666;
    }

    /* Add styles for coffee button */
    #coffeeBtn {
      color: #fff;
      text-decoration: none;
      display: inline-block;
    }

    /* Style for list rearrange buttons */
    .rearrange-buttons {
      opacity: 0;
      transition: opacity 0.2s ease;
      position: absolute;
      left: 10px;
      display: flex;
      gap: 5px;
      z-index: 1; /* Ensure buttons appear above the title */
    }

    .list-header {
      position: relative; /* For absolute positioning of rearrange buttons */
    }

    .list-header .editable {
      transition: margin-left 0.2s ease;
      margin-left: 0;
    }

    .list-header:hover .editable {
      margin-left: 85px; /* Increased margin to accommodate two buttons + gap */
    }

    .list-header:hover .rearrange-buttons {
      opacity: 1;
    }

    /* Disabled button styles */
    button:disabled {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* Update editor popup styles */
    .editor-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 800px;
      height: 80%;
      background: var(--card-bg);
      z-index: 1000;
      padding: 0;  /* Remove padding */
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      flex-direction: column;  /* Stack children vertically */
    }

    .editor-popup .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;  /* Add padding to header instead */
      border-bottom: 1px solid var(--border-color);
      background: var(--header-bg);
      border-radius: 8px 8px 0 0;
    }

    /* Add styles for the editor container */
    .editor-popup #summernote {
      flex: 1;  /* Fill remaining space */
      display: flex;
      flex-direction: column;
    }

    /* Make Summernote fill the container */
    .editor-popup .note-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .editor-popup .note-editing-area {
      flex: 1;
    }

    .editor-popup .note-editable {
      height: 100% !important;  /* Force full height */
    }

    /* Update Summernote theme styles */
    .note-editor .note-editable {
      background-color: var(--card-bg) !important;
      color: var(--text-color) !important;
    }

    .note-editor .note-toolbar {
      background-color: var(--header-bg) !important;
      border-color: var(--border-color) !important;
    }

    .note-editor .note-toolbar .note-btn {
      background-color: var(--item-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-color) !important;
    }

    .note-editor .note-toolbar .note-btn:hover {
      background-color: var(--item-hover) !important;
    }

    .note-editor.note-frame {
      border-color: var(--border-color) !important;
    }

    .note-editor .note-status-output,
    .note-editor .note-statusbar {
      background-color: var(--header-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-color) !important;
    }

    /* Style dropdowns */
    .note-editor .note-dropdown-menu {
      background-color: var(--card-bg) !important;
      border-color: var(--border-color) !important;
    }

    .note-editor .note-dropdown-item {
      color: var(--text-color) !important;
    }

    .note-editor .note-dropdown-item:hover {
      background-color: var(--item-hover) !important;
    }

    /* Override Coloris default styles */
    [data-coloris] {
      padding: 5px !important;
      width: auto !important;
      height: auto !important;
      border: none !important;
      background: none !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    /* Hide the default Coloris preview box */
    [data-coloris]::before {
      display: none !important;
    }

    /* Style our custom icon */
    .color-picker-btn .fa-paintbrush {
      font-size: 14px !important;
      color: var(--text-color) !important;
      display: inline-block !important;
      pointer-events: none !important;
    }

    /* Add new CSS for item links */
    .item-link {
      color: #0066cc;
      text-decoration: underline;
      cursor: pointer;
    }

    .item-link:hover {
      color: #0052a3;
    }

    /* Prevent link styling when editing */
    [contenteditable="true"] .item-link {
      color: inherit;
      text-decoration: none;
      cursor: text;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="top-menu">
      <button id="themeToggleBtn" title="Toggle Theme">
        <i class="fas fa-sun"></i>
      </button>
      <button id="addProjectBtn" title="Create New Project">New Project</button>
      <button id="importDataBtn" title="Import Data">Import</button>
      <button id="exportDataBtn" title="Export Data">Export</button>
      <a href="https://buymeacoffee.com/itcon" target="_blank" id="coffeeBtn">
        <button title="Buy me a coffee">
          <i class="fas fa-mug-hot"></i>
        </button>
      </a>
    </div>
    <div id="projectsContainer" class="projects-container"></div>
  </div>

  <!-- Add editor popup HTML -->
  <div class="editor-overlay"></div>
  <div class="editor-popup">
    <div class="editor-header">
      <h3>Edit Note</h3>
      <button class="close-btn">Close</button>
    </div>
    <div id="summernote"></div>
  </div>

  <script>
    const projectsContainer = document.getElementById("projectsContainer");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const importDataBtn = document.getElementById("importDataBtn");
    const exportDataBtn = document.getElementById("exportDataBtn");
    const themeToggleBtn = document.getElementById("themeToggleBtn");

    let appData = JSON.parse(localStorage.getItem("kanbanData")) || [];
    let currentTheme = localStorage.getItem("theme") || "light";

    function saveData() {
      localStorage.setItem("kanbanData", JSON.stringify(appData));
    }

    function createEditableElement(tag, value, onChange) {
      const el = document.createElement(tag);
      el.classList.add("editable");
      el.innerHTML = formatTextWithLinks(value);

      el.contentEditable = false;

      el.addEventListener("dblclick", () => {
        el.contentEditable = true;
        el.textContent = el.textContent;
        el.focus();
        document.execCommand("selectAll", false, null);
      });

      el.addEventListener("blur", () => {
        el.contentEditable = false;
        const newValue = el.textContent;
        onChange(newValue);
        el.innerHTML = formatTextWithLinks(newValue);
      });

      el.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          if (event.shiftKey) {
            event.preventDefault();
            document.execCommand('insertLineBreak');
          } else {
            event.preventDefault();
            el.blur();
          }
        }
      });

      return el;
    }

    function createDeleteButton(deleteAction) {
      const deleteButton = document.createElement("button");
      deleteButton.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
      deleteButton.title = "Delete";  // Default title
      
      let confirmTimeout;
      let isConfirming = false;

      deleteButton.addEventListener("click", () => {
        if (isConfirming) {
          clearTimeout(confirmTimeout);
          deleteAction();
        } else {
          isConfirming = true;
          deleteButton.innerHTML = 'Sure?';
          deleteButton.title = "Click again to confirm deletion";
          deleteButton.classList.add('delete-confirm');

          confirmTimeout = setTimeout(() => {
            isConfirming = false;
            deleteButton.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
            deleteButton.title = "Delete";
            deleteButton.classList.remove('delete-confirm');
          }, 5000);
        }
      });

      return deleteButton;
    }

    function createProject(project) {
      const projectDiv = document.createElement("div");
      projectDiv.classList.add("project");

      const header = document.createElement("div");
      header.classList.add("project-header");
      header.style.justifyContent = "flex-end";

      const projectNameEl = createEditableElement(
        "div",
        project.name,
        (newName) => {
          project.name = newName;
          saveData();
        }
      );
      projectNameEl.style.flexGrow = "1";

      // Add the new Add List button
      const addListBtn = document.createElement("button");
      addListBtn.classList.add("add-list-btn");
      addListBtn.innerHTML = '<i class="fas fa-plus"></i>';
      addListBtn.title = "Add New List";
      
      const collapseBtn = document.createElement("button");
      collapseBtn.classList.add("collapse-btn");
      collapseBtn.innerHTML = project.collapsed
        ? '<i class="fas fa-chevron-down"></i>'
        : '<i class="fas fa-chevron-up"></i>';
      collapseBtn.title = project.collapsed ? "Expand Project" : "Collapse Project";

      const moveUpBtn = document.createElement("button");
      moveUpBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
      moveUpBtn.title = "Move Project Up";
      moveUpBtn.disabled = appData.indexOf(project) === 0 || appData.length === 1;

      const moveDownBtn = document.createElement("button");
      moveDownBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
      moveDownBtn.title = "Move Project Down";
      moveDownBtn.disabled = appData.indexOf(project) === appData.length - 1 || appData.length === 1;

      const deleteProjectButton = createDeleteButton(() => {
        appData = appData.filter((p) => p.id !== project.id);
        saveData();
        renderProjects();
      });
      deleteProjectButton.title = "Delete Project";

      header.appendChild(projectNameEl);
      // Add the new button before the collapse button
      [addListBtn, collapseBtn, moveUpBtn, moveDownBtn, deleteProjectButton].forEach(
        (btn) => {
          btn.style.marginLeft = "5px";
          header.appendChild(btn);
        }
      );

      const listsContainer = document.createElement("div");
      listsContainer.classList.add("lists-container");
      if (project.collapsed) listsContainer.style.display = "none";

      project.lists.forEach((list, index) =>
        createList(project, list, listsContainer, index, project.lists.length)
      );

      projectDiv.appendChild(header);
      projectDiv.appendChild(listsContainer);
      projectsContainer.appendChild(projectDiv);
    }

    function createList(project, list, container, index, totalLists) {
      const listDiv = document.createElement("div");
      listDiv.classList.add("list");

      const header = document.createElement("div");
      header.classList.add("list-header");

      const listNameEl = createEditableElement(
        "div",
        list.name,
        (newName) => {
          list.name = newName;
          saveData();
        }
      );
      listNameEl.style.flexGrow = "1";

      const deleteListButton = createDeleteButton(() => {
        project.lists = project.lists.filter((l) => l.id !== list.id);
        saveData();
        renderProjects();
      });

      const rearrangeButtons = document.createElement("div");
      rearrangeButtons.classList.add("rearrange-buttons");

      if (index > 0) {
        const movePrevBtn = document.createElement("button");
        movePrevBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
        movePrevBtn.title = "Move List Left";
        movePrevBtn.addEventListener("click", () => {
          [project.lists[index], project.lists[index - 1]] = [
            project.lists[index - 1],
            project.lists[index],
          ];
          saveData();
          renderProjects();
        });
        rearrangeButtons.appendChild(movePrevBtn);
      }

      if (index < totalLists - 1) {
        const moveNextBtn = document.createElement("button");
        moveNextBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
        moveNextBtn.title = "Move List Right";
        moveNextBtn.addEventListener("click", () => {
          [project.lists[index], project.lists[index + 1]] = [
            project.lists[index + 1],
            project.lists[index],
          ];
          saveData();
          renderProjects();
        });
        rearrangeButtons.appendChild(moveNextBtn);
      }

      header.appendChild(rearrangeButtons);
      header.appendChild(listNameEl);

      const addTodoButton = document.createElement("button");
      addTodoButton.innerHTML = '<i class="fa-regular fa-square-check"></i>';
      addTodoButton.title = "New Todo";
      addTodoButton.addEventListener("click", () => {
        const newItem = {
          id: Date.now(),
          name: "New ToDo",
          type: "todo",
          completed: false,
        };
        list.items.push(newItem);
        saveData();
        renderProjects();
        // Open editor immediately for the new item
        openEditor(newItem);
      });

      const addNoteButton = document.createElement("button");
      addNoteButton.innerHTML = '<i class="fa-regular fa-note-sticky"></i>';
      addNoteButton.title = "New Note";
      addNoteButton.addEventListener("click", () => {
        const newItem = { id: Date.now(), name: "New Note", type: "note" };
        list.items.push(newItem);
        saveData();
        renderProjects();
        // Open editor immediately for the new item
        openEditor(newItem);
      });

      header.appendChild(addTodoButton);
      header.appendChild(addNoteButton);
      header.appendChild(deleteListButton);

      const listItemsContainer = document.createElement("div");
      listItemsContainer.classList.add("list-items");

      // Add drag and drop handlers for the list container
      listItemsContainer.addEventListener("dragover", (e) => {
        e.preventDefault();
        const draggingItem = document.querySelector(".dragging");
        if (!draggingItem) return;

        // If the container is empty or we're hovering at the bottom
        const items = Array.from(listItemsContainer.children);
        const lastItem = items[items.length - 1];

        if (!items.length || (lastItem && e.clientY > lastItem.getBoundingClientRect().bottom)) {
          removePlaceholders();
          const placeholder = createPlaceholder();
          listItemsContainer.appendChild(placeholder);
        }
      });

      listItemsContainer.addEventListener("dragleave", () => {
        listItemsContainer.classList.remove("drop-highlight");
      });

      listItemsContainer.addEventListener("drop", (e) => {
        e.preventDefault();

        try {
          const { itemId, listId } = JSON.parse(e.dataTransfer.getData("text/plain"));

          // Find source list and item
          const sourceList = appData
            .flatMap(p => p.lists)
            .find(l => l.id === listId);
          const draggedItem = sourceList.items.find(i => i.id === itemId);

          if (!draggedItem) return;

          // Remove item from source list
          sourceList.items = sourceList.items.filter(i => i.id !== itemId);

          // Find the insertion point based on the placeholder position
          const placeholder = listItemsContainer.querySelector('.drop-placeholder');
          if (placeholder) {
            const items = Array.from(listItemsContainer.children);
            const placeholderIndex = items.indexOf(placeholder);
            // If placeholder exists, insert at its position
            list.items.splice(placeholderIndex, 0, draggedItem);
          } else {
            // If no placeholder (empty list), add to the end
            list.items.push(draggedItem);
          }

          saveData();
          renderProjects();
        } catch (err) {
          console.error("Error during drag and drop:", err);
        }
      });

      // Ensure list.items exists
      if (!list.items) list.items = [];

      list.items.forEach((item) => createListItem(list, item, listItemsContainer));

      listDiv.appendChild(header);
      listDiv.appendChild(listItemsContainer);
      container.appendChild(listDiv);
    }

    function createListItem(list, item, container) {
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("list-item");
      itemDiv.setAttribute("draggable", "true");
      
      // Set background color if it exists
      if (item.backgroundColor) {
        itemDiv.style.backgroundColor = item.backgroundColor;
      }

      // Create hover menu
      const hoverMenu = document.createElement("div");
      hoverMenu.classList.add("item-hover-menu");

      // Create hidden input for color picker
      const colorInput = document.createElement('input');
      colorInput.type = 'text';
      colorInput.setAttribute('data-coloris', '');
      colorInput.style.display = 'none';
      
      // Create color picker button
      const colorPickerBtn = document.createElement("button");
      colorPickerBtn.innerHTML = '<i class="fas fa-fill-drip"></i>';
      colorPickerBtn.title = "Change Color";
      
      // When button is clicked, trigger the color input
      colorInput.addEventListener('click', () => {
        colorInput.click();
      });
      
      // Add event listener for when color changes
      colorInput.addEventListener('coloris:pick', event => {
        const color = event.detail.color;
        item.backgroundColor = color;
        itemDiv.style.backgroundColor = color;
        saveData();
      });

      // Create editor button
      const editorBtn = document.createElement("button");
      editorBtn.innerHTML = '<i class="fas fa-pen-to-square"></i>';
      editorBtn.title = "Open Editor";
      editorBtn.addEventListener("click", () => openEditor(item));

      // Add buttons to hover menu in desired order
      hoverMenu.appendChild(editorBtn);
      hoverMenu.appendChild(colorPickerBtn);
      hoverMenu.appendChild(colorInput);

      // Create and add delete button
      const deleteButton = createDeleteButton(() => {
        list.items = list.items.filter((i) => i.id !== item.id);
        saveData();
        renderProjects();
      });
      hoverMenu.appendChild(deleteButton);

      itemDiv.appendChild(hoverMenu);

      // Create item content div (non-editable)
      const itemContent = document.createElement("div");
      if (item.type === "todo") {
        itemDiv.classList.add("todo-item");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = item.completed;
        checkbox.classList.add("todo-checkbox");
        checkbox.addEventListener("change", () => {
          item.completed = checkbox.checked;
          itemContent.classList.toggle("strikethrough", item.completed);
          saveData();
        });

        itemDiv.appendChild(checkbox);
        
        itemContent.classList.add("item-name");
        if (item.completed) {
          itemContent.classList.add("strikethrough");
        }
      }

      // Set content and make it clickable to open editor
      itemContent.innerHTML = formatTextWithLinks(item.content ? stripHtml(item.content).substring(0, 100) + "..." : item.name);
      itemContent.addEventListener("click", () => openEditor(item));
      itemContent.style.cursor = "pointer";
      
      itemDiv.appendChild(itemContent);
      container.appendChild(itemDiv);

      // Updated drag and drop handlers
      itemDiv.addEventListener("dragstart", (e) => {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", JSON.stringify({
          itemId: item.id,
          listId: list.id
        }));
        itemDiv.classList.add("dragging");

        // Remove any existing placeholders
        removePlaceholders();
      });

      itemDiv.addEventListener("dragend", () => {
        itemDiv.classList.remove("dragging");
        // Remove any existing placeholders and shift classes
        removePlaceholders();
        document.querySelectorAll('.shift-up, .shift-down').forEach(el => {
          el.classList.remove('shift-up', 'shift-down');
        });
      });

      itemDiv.addEventListener("dragover", (e) => {
        e.preventDefault();
        const draggingItem = document.querySelector(".dragging");
        if (!draggingItem || draggingItem === itemDiv) return;

        removePlaceholders();

        const rect = itemDiv.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;

        if (e.clientY < midY) {
          // Insert placeholder before this item
          const placeholder = createPlaceholder();
          itemDiv.before(placeholder);
          // Shift this and following items down
          itemDiv.classList.add('shift-down');
        } else {
          // Insert placeholder after this item
          const placeholder = createPlaceholder();
          itemDiv.after(placeholder);
          // Shift following items down
          const nextSibling = itemDiv.nextElementSibling;
          if (nextSibling && !nextSibling.classList.contains('drop-placeholder')) {
            nextSibling.classList.add('shift-down');
          }
        }
      });

      itemDiv.addEventListener("dragleave", () => {
        itemDiv.classList.remove("drop-highlight-top", "drop-highlight-bottom");
      });

      itemDiv.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation(); // Prevent event from bubbling to container

        try {
          const { itemId, listId } = JSON.parse(e.dataTransfer.getData("text/plain"));

          // Find source list and item
          const sourceList = appData
            .flatMap(p => p.lists)
            .find(l => l.id === listId);
          const draggedItem = sourceList.items.find(i => i.id === itemId);

          if (!draggedItem || draggedItem.id === item.id) return;

          // Remove item from source list
          sourceList.items = sourceList.items.filter(i => i.id !== itemId);

          // Find target position and insert
          const targetIndex = list.items.indexOf(item);
          const rect = itemDiv.getBoundingClientRect();
          const dropPosition = e.clientY < rect.top + rect.height / 2 ? targetIndex : targetIndex + 1;

          list.items.splice(dropPosition, 0, draggedItem);
          saveData();
          renderProjects();
        } catch (err) {
          console.error("Error during drag and drop:", err);
        }
      });
    }

    function createPlaceholder() {
      const placeholder = document.createElement('div');
      placeholder.classList.add('drop-placeholder');
      return placeholder;
    }

    function removePlaceholders() {
      document.querySelectorAll('.drop-placeholder').forEach(el => el.remove());
    }

    function renderProjects() {
      projectsContainer.innerHTML = "";
      appData.forEach((project) => createProject(project));
      
      // Configure global Coloris settings
      Coloris({
        theme: 'default',
        themeMode: currentTheme,
        formatToggle: false,
        clearButton: true,
        alpha: false,
        wrap: true,
        closeButton: true,
        swatches: [
          '#264653',
          '#2a9d8f',
          '#e9c46a',
          '#f4a261',
          '#e76f51',
          '#ef476f',
          '#ffd166',
          '#06d6a0',
          '#118ab2',
          '#073b4c'
        ]
      });
    }

    addProjectBtn.addEventListener("click", () => {
      const newProject = { id: Date.now(), name: "New Project", lists: [] };
      appData.push(newProject);
      saveData();
      renderProjects();
    });

    importDataBtn.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";

      input.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);
              if (Array.isArray(importedData)) {
                appData = importedData;
                saveData();
                renderProjects();
                alert("Data successfully imported!");
              } else {
                alert(
                  "Invalid file format. Please upload a valid JSON file."
                );
              }
            } catch (error) {
              alert("Failed to read file. Ensure it is a valid JSON file.");
            }
          };
          reader.readAsText(file);
        }
      });

      input.click();
    });

    exportDataBtn.addEventListener("click", () => {
      const data = JSON.stringify(appData, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kanban-data.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Add this function to handle theme switching
    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      currentTheme = theme;
      themeToggleBtn.innerHTML = theme === "dark" 
        ? '<i class="fas fa-sun"></i>' 
        : '<i class="fas fa-moon"></i>';
    }

    // Initialize theme
    setTheme(currentTheme);

    // Add event listener for theme toggle
    themeToggleBtn.addEventListener("click", () => {
      const newTheme = currentTheme === "light" ? "dark" : "light";
      setTheme(newTheme);
    });

    document.addEventListener('DOMContentLoaded', () => {
      Coloris({
        theme: 'default',
        themeMode: currentTheme,
        formatToggle: false,
        clearButton: true,
        alpha: false,
        wrap: true,
        closeButton: true,
        swatches: [
          '#264653',
          '#2a9d8f',
          '#e9c46a',
          '#f4a261',
          '#e76f51',
          '#ef476f',
          '#ffd166',
          '#06d6a0',
          '#118ab2',
          '#073b4c'
        ]
      });

      // Initial render of projects
      renderProjects();
    });

    // Add helper function to strip HTML
    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    // Add editor functionality
    function openEditor(item) {
      const popup = document.querySelector('.editor-popup');
      const overlay = document.querySelector('.editor-overlay');
      const closeBtn = popup.querySelector('.close-btn');
      
      // Initialize Summernote
      $('#summernote').summernote({
        height: '100%',
        toolbar: [
          ['style', ['style']],
          ['font', ['bold', 'underline', 'clear']],
          ['color', ['color']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['table', ['table']],
          ['insert', ['link']],
          ['view', ['fullscreen', 'codeview', 'help']]
        ],
        callbacks: {
          onChange: function(contents) {
            item.content = contents;
            saveData();
          }
        }
      });

      // Set content
      $('#summernote').summernote('code', item.content || item.name);

      // Show popup and overlay
      popup.style.display = 'flex';
      overlay.style.display = 'block';

      // Handle close
      const closeEditor = () => {
        $('#summernote').summernote('destroy');
        popup.style.display = 'none';
        overlay.style.display = 'none';
        renderProjects(); // Refresh to show updated content
      };

      closeBtn.onclick = closeEditor;
      overlay.onclick = closeEditor;
    }

    // Add this new helper function
    function formatTextWithLinks(text) {
      if (!text) return '';
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, (url) => {
        const safeUrl = url
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
        return `<a href="${safeUrl}" class="item-link" target="_blank">${safeUrl}</a>`;
      });
    }
  </script>
</body>

</html>