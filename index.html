<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Tracker</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      .editable {
        border: none;
        outline: none;
      }

      .editable:focus {
        border-bottom: 2px solid #007bff;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        font-size: 16px;
        background-color: #f4f4f4;
      }
      h1 {
        margin: 0;
        padding: 15px;
        background-color: #007bff;
        color: white;
      }
      .container {
        padding: 15px;
      }
      .top-menu {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 10px;
      }
      .top-menu button {
        padding: 5px 10px;
        background-color: #555555;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .top-menu button:hover {
        background-color: #0056b3;
      }
      .projects-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        background-color: #ffffff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
      }
      .project {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background-color: #fafafa;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .project-header .editable {
        cursor: pointer;
        border: none;
        background-color: transparent;
        font-size: 1.2em;
        padding: 5px;
        outline: none;
        transition: border-bottom 0.2s;
      }
      .project-header .editable:focus {
        border-bottom: 2px solid #007bff;
      }
      .lists-container {
        display: flex;
        gap: 15px;
      }
      .highlight {
        border: 2px dashed #007bff;
        background-color: #f0f8ff;
      }
      .list {
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #ffffff;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        gap: 5px;
      }
      .list-header .rearrange-buttons {
        display: flex;
        gap: 5px;
      }
      .list-items {
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .list-item {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
        cursor: move; /* Indicates draggable items */
      }
      .list-item:hover {
        background-color: #dee2e6;
      }
      .drop-highlight {
        border: 2px dashed #007bff; /* Highlight effect when an item is over this area */
        background-color: #f0f8ff;
      }
      .list-item.todo-item {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .list-item.todo-item .item-name {
        flex: 1;
      }
      .list-item.todo-item .item-name.strikethrough {
        text-decoration: line-through;
        color: gray;
      }
      .add-item-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
      }
      .add-item {
        cursor: pointer;
        background: none;
        text-align: center;
        padding: 10px;
        border: dashed 1px;
        border-radius: 5px;
        color: #6c757d;
        flex: 1;
      }
      .add-item:hover {
        background-color: #f8f9fa;
      }

      .add-list {
        cursor: pointer;
        background: none;
        text-align: center;
        padding: 10px;
        border: dashed 1px;
        border-radius: 5px;
        color: #6c757d;
      }
      .add-list:hover {
        background-color: #f8f9fa;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-menu">
        <button id="importDataBtn">Import</button>
        <button id="exportDataBtn">Export</button>
        <button id="addProjectBtn">
          <i class="fas fa-plus"></i> Add Project
        </button>
      </div>
      <div id="projectsContainer" class="projects-container"></div>
    </div>

    <script>
      const projectsContainer = document.getElementById("projectsContainer");
      const addProjectBtn = document.getElementById("addProjectBtn");
      const importDataBtn = document.getElementById("importDataBtn");
      const exportDataBtn = document.getElementById("exportDataBtn");

      let appData = JSON.parse(localStorage.getItem("kanbanData")) || [];

      function saveData() {
        localStorage.setItem("kanbanData", JSON.stringify(appData));
      }

      function createEditableElement(tag, value, onChange) {
        const el = document.createElement(tag);
        el.classList.add("editable");
        el.textContent = value;

        el.contentEditable = false;

        el.addEventListener("dblclick", () => {
          el.contentEditable = true;
          el.focus();
          document.execCommand("selectAll", false, null);
        });

        el.addEventListener("blur", () => {
          el.contentEditable = false;
          onChange(el.textContent);
        });

        el.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            el.blur();
            event.preventDefault();
          }
        });

        return el;
      }

      function createProject(project) {
        const projectDiv = document.createElement("div");
        projectDiv.classList.add("project");

        const header = document.createElement("div");
        header.classList.add("project-header");
        header.style.justifyContent = "flex-end";

        const projectNameEl = createEditableElement(
          "div",
          project.name,
          (newName) => {
            project.name = newName;
            saveData();
          }
        );
        projectNameEl.style.flexGrow = "1";

        const collapseBtn = document.createElement("button");
        collapseBtn.classList.add("collapse-btn");
        collapseBtn.innerHTML = project.collapsed
          ? '<i class="fas fa-chevron-down"></i>'
          : '<i class="fas fa-chevron-up"></i>';
        collapseBtn.addEventListener("click", () => {
          project.collapsed = !project.collapsed;
          saveData();
          renderProjects();
        });

        const moveUpBtn = document.createElement("button");
        moveUpBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
        moveUpBtn.disabled = appData.indexOf(project) === 0;
        moveUpBtn.addEventListener("click", () => {
          const index = appData.indexOf(project);
          if (index > 0) {
            [appData[index], appData[index - 1]] = [
              appData[index - 1],
              appData[index],
            ];
            saveData();
            renderProjects();
          }
        });

        const moveDownBtn = document.createElement("button");
        moveDownBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
        moveDownBtn.disabled = appData.indexOf(project) === appData.length - 1;
        moveDownBtn.addEventListener("click", () => {
          const index = appData.indexOf(project);
          if (index < appData.length - 1) {
            [appData[index], appData[index + 1]] = [
              appData[index + 1],
              appData[index],
            ];
            saveData();
            renderProjects();
          }
        });

        const deleteProjectButton = document.createElement("button");
        deleteProjectButton.innerHTML =
          '<i class="fa-regular fa-trash-can"></i>';
        deleteProjectButton.addEventListener("click", () => {
          appData = appData.filter((p) => p.id !== project.id);
          saveData();
          renderProjects();
        });

        header.appendChild(projectNameEl);
        [collapseBtn, moveUpBtn, moveDownBtn, deleteProjectButton].forEach(
          (btn) => {
            btn.style.marginLeft = "5px";
            header.appendChild(btn);
          }
        );

        const listsContainer = document.createElement("div");
        listsContainer.classList.add("lists-container");
        if (project.collapsed) listsContainer.style.display = "none";

        project.lists.forEach((list, index) =>
          createList(project, list, listsContainer, index, project.lists.length)
        );

        const addListDiv = document.createElement("div");
        addListDiv.classList.add("add-list");
        addListDiv.textContent = "Add List";
        addListDiv.addEventListener("click", () => {
          const newList = { id: Date.now(), name: "New List", items: [] };
          project.lists.push(newList);
          saveData();
          renderProjects();
        });

        listsContainer.appendChild(addListDiv);

        projectDiv.appendChild(header);
        projectDiv.appendChild(listsContainer);
        projectsContainer.appendChild(projectDiv);
      }

      function createList(project, list, container, index, totalLists) {
        const listDiv = document.createElement("div");
        listDiv.classList.add("list");

        const header = document.createElement("div");
        header.classList.add("list-header");

        const listNameEl = createEditableElement(
          "div",
          list.name,
          (newName) => {
            list.name = newName;
            saveData();
          }
        );
        listNameEl.style.flexGrow = "1";

        const deleteListButton = document.createElement("button");
        deleteListButton.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
        deleteListButton.addEventListener("click", () => {
          project.lists = project.lists.filter((l) => l.id !== list.id);
          saveData();
          renderProjects();
        });

        const rearrangeButtons = document.createElement("div");
        rearrangeButtons.classList.add("rearrange-buttons");

        if (index > 0) {
          const movePrevBtn = document.createElement("button");
          movePrevBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
          movePrevBtn.addEventListener("click", () => {
            [project.lists[index], project.lists[index - 1]] = [
              project.lists[index - 1],
              project.lists[index],
            ];
            saveData();
            renderProjects();
          });
          rearrangeButtons.appendChild(movePrevBtn);
        }

        if (index < totalLists - 1) {
          const moveNextBtn = document.createElement("button");
          moveNextBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
          moveNextBtn.addEventListener("click", () => {
            [project.lists[index], project.lists[index + 1]] = [
              project.lists[index + 1],
              project.lists[index],
            ];
            saveData();
            renderProjects();
          });
          rearrangeButtons.appendChild(moveNextBtn);
        }

        header.appendChild(rearrangeButtons);
        header.appendChild(listNameEl);

        const addTodoButton = document.createElement("button");
        addTodoButton.innerHTML = '<i class="fa-regular fa-square-check"></i>';
        addTodoButton.addEventListener("click", () => {
          const newItem = {
            id: Date.now(),
            name: "New ToDo",
            type: "todo",
            completed: false,
          };
          list.items.push(newItem);
          saveData();
          renderProjects();
        });

        const addNoteButton = document.createElement("button");
        addNoteButton.innerHTML = '<i class="fa-regular fa-note-sticky"></i>';
        addNoteButton.addEventListener("click", () => {
          const newItem = { id: Date.now(), name: "New Note", type: "note" };
          list.items.push(newItem);
          saveData();
          renderProjects();
        });

        header.appendChild(addTodoButton);
        header.appendChild(addNoteButton);
        header.appendChild(deleteListButton);

        const listItemsContainer = document.createElement("div");
        listItemsContainer.classList.add("list-items");

        list.items.forEach((item) =>
          createListItem(list, item, listItemsContainer)
        );

        listDiv.appendChild(header);
        listDiv.appendChild(listItemsContainer);
        container.appendChild(listDiv);
      }

      function createListItem(list, item, container) {
        const itemDiv = document.createElement("div");
        itemDiv.classList.add("list-item");
        itemDiv.setAttribute("draggable", "true"); // Set draggable attribute

        if (item.type === "todo") {
          itemDiv.classList.add("todo-item");

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = item.completed;
          checkbox.addEventListener("change", () => {
            item.completed = checkbox.checked;
            saveData();
            renderProjects();
          });

          const itemNameEl = createEditableElement(
            "div",
            item.name,
            (newName) => {
              item.name = newName;
              saveData();
            }
          );
          itemNameEl.classList.add("item-name");

          itemDiv.appendChild(checkbox);
          itemDiv.appendChild(itemNameEl);
        } else {
          const itemNameEl = createEditableElement(
            "div",
            item.name,
            (newName) => {
              item.name = newName;
              saveData();
            }
          );
          itemDiv.appendChild(itemNameEl);
        }

        const deleteItemButton = document.createElement("button");
        deleteItemButton.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
        deleteItemButton.addEventListener("click", () => {
          list.items = list.items.filter((i) => i.id !== item.id);
          saveData();
          renderProjects();
        });

        itemDiv.appendChild(deleteItemButton);
        container.appendChild(itemDiv);

        // Drag-and-drop functionality for list items
        itemDiv.addEventListener("dragstart", (e) => {
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", item.id); // Pass item ID
          itemDiv.classList.add("dragging"); // Add visual indication
        });

        itemDiv.addEventListener("dragend", () => {
          itemDiv.classList.remove("dragging"); // Remove visual indication
        });

        itemDiv.addEventListener("dragover", (e) => {
          e.preventDefault(); // Allow drop
          itemDiv.classList.add("drop-highlight"); // Highlight when dragging over
        });

        itemDiv.addEventListener("dragleave", () => {
          itemDiv.classList.remove("drop-highlight"); // Remove highlight
        });

        itemDiv.addEventListener("drop", (e) => {
          e.preventDefault();
          const draggedItemId = e.dataTransfer.getData("text/plain");
          const draggedItem = list.items.find((i) => i.id == draggedItemId);
          if (draggedItem && draggedItem.id !== item.id) {
            // Check not dragging the same item
            const bounding = target.getBoundingClientRect();
            const offset = bounding.y + bounding.height / 2;
            const isAbove = e.clientY < offset; // Determine if dropped above or below

            // Insert the dragged item above/below the target
            if (isAbove) {
              target.parentElement.insertBefore(draggedItem, target); // Insert before the target item
            } else {
              target.parentElement.insertBefore(
                draggedItem,
                target.nextSibling
              ); // Insert after the target item
            }
            saveData();
            renderProjects();
          }
          itemDiv.classList.remove("drop-highlight"); // Remove highlight after drop
        });
      }

      function renderProjects() {
        projectsContainer.innerHTML = "";
        appData.forEach((project) => createProject(project));
      }

      addProjectBtn.addEventListener("click", () => {
        const newProject = { id: Date.now(), name: "New Project", lists: [] };
        appData.push(newProject);
        saveData();
        renderProjects();
      });

      importDataBtn.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "application/json";

        input.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const importedData = JSON.parse(e.target.result);
                if (Array.isArray(importedData)) {
                  appData = importedData;
                  saveData();
                  renderProjects();
                  alert("Data successfully imported!");
                } else {
                  alert(
                    "Invalid file format. Please upload a valid JSON file."
                  );
                }
              } catch (error) {
                alert("Failed to read file. Ensure it is a valid JSON file.");
              }
            };
            reader.readAsText(file);
          }
        });

        input.click();
      });

      exportDataBtn.addEventListener("click", () => {
        const data = JSON.stringify(appData, null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "kanban-data.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      renderProjects();
    </script>
  </body>
</html>
