<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    /* Add these CSS variables at the start of the style section */
    :root {
      --bg-color: #f4f4f4;
      --text-color: #000000;
      --card-bg: #ffffff;
      --item-bg: #e9ecef;
      --item-hover: #dee2e6;
      --border-color: #ddd;
      --header-bg: #f8f9fa;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --card-bg: #2d2d2d;
      --item-bg: #3d3d3d;
      --item-hover: #4d4d4d;
      --border-color: #404040;
      --header-bg: #2a2a2a;
    }

    .editable {
      border: none;
      outline: none;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      font-size: 16px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .container {
      padding: 15px;
    }

    .top-menu {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 10px;
    }

    .top-menu button {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .top-menu button:hover {
      background-color: #000;
    }

    .projects-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .project {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      background-color: var(--card-bg);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .project-header .editable {
      cursor: pointer;
      border: none;
      background-color: transparent;
      font-size: 1.2em;
      padding: 5px;
      outline: none;
      transition: border-bottom 0.2s;
    }

    .lists-container {
      display: flex;
      gap: 15px;
    }

    .highlight {
      background-color: #f0f8ff;
    }

    .list {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--card-bg);
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--header-bg);
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      gap: 5px;
    }

    .list-header .rearrange-buttons {
      display: flex;
      gap: 5px;
    }

    .list-items {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .list-item {
      background-color: var(--item-bg);
      padding: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
      cursor: move;
      /* Indicates draggable items */
    }

    .list-item:hover {
      background-color: var(--item-hover);
    }

    .drop-highlight {
      /* Highlight effect when an item is over this area */
      background-color: #f0f8ff;
    }

    .list-item.todo-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .list-item.todo-item .item-name {
      flex: 1;
    }

    .list-item.todo-item .item-name.strikethrough {
      text-decoration: line-through;
      color: gray;
    }

    .add-item-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .add-item {
      cursor: pointer;
      background: none;
      text-align: center;
      padding: 10px;
      border: dashed 1px;
      border-radius: 5px;
      color: #6c757d;
      flex: 1;
    }

    .add-item:hover {
      background-color: #f8f9fa;
    }

    .add-list {
      cursor: pointer;
      background: none;
      text-align: center;
      padding: 10px;
      border: dashed 1px;
      border-radius: 5px;
      color: #6c757d;
    }

    .add-list:hover {
      background-color: #f8f9fa;
    }

    .dragging {
      opacity: 0.5;
      cursor: move;
    }

    .drop-placeholder {
      height: 2px;
      background-color: #555555;
      margin: 10px 0;
      transition: all 0.2s ease;
      position: relative;
    }

    .drop-placeholder::before {
      content: '';
      position: absolute;
      left: -5px;
      top: -4px;
      width: 10px;
      height: 10px;
      background-color: #555555;
      border-radius: 50%;
    }

    .drop-placeholder::after {
      content: '';
      position: absolute;
      right: -5px;
      top: -4px;
      width: 10px;
      height: 10px;
      background-color: #555555;
      border-radius: 50%;
    }

   .list-items {
      min-height: 50px;
      /* Ensure empty lists have drop area */
      padding: 10px;
    }

    .list-item.shift-up {
      transform: translateY(-100%);
      transition: transform 0.2s ease;
    }

    .list-item.shift-down {
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }

    .delete-confirm:hover {
      background-color: #000 !important;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }

      100% {
        opacity: 1;
      }
    }

    /* Custom checkbox styling */
    .todo-checkbox {
      accent-color: #28a745;  /* Green color for checked state */
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .list-item button {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .list-item:hover button {
      opacity: 1;
    }

    /* Add style for theme toggle button */
    #themeToggleBtn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #themeToggleBtn:hover {
      background-color: #000;
    }

    [data-theme="dark"] #themeToggleBtn:hover {
      background-color: #666;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="top-menu">
      <button id="themeToggleBtn">
        <i class="fas fa-sun"></i>
      </button>
      <button id="addProjectBtn">New Project</button>
      <button id="importDataBtn">Import</button>
      <button id="exportDataBtn">Export</button>
    </div>
    <div id="projectsContainer" class="projects-container"></div>
  </div>

  <script>
    const projectsContainer = document.getElementById("projectsContainer");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const importDataBtn = document.getElementById("importDataBtn");
    const exportDataBtn = document.getElementById("exportDataBtn");
    const themeToggleBtn = document.getElementById("themeToggleBtn");

    let appData = JSON.parse(localStorage.getItem("kanbanData")) || [];
    let currentTheme = localStorage.getItem("theme") || "light";

    function saveData() {
      localStorage.setItem("kanbanData", JSON.stringify(appData));
    }

    function createEditableElement(tag, value, onChange) {
      const el = document.createElement(tag);
      el.classList.add("editable");
      el.textContent = value;

      el.contentEditable = false;

      el.addEventListener("dblclick", () => {
        el.contentEditable = true;
        el.focus();
        document.execCommand("selectAll", false, null);
      });

      el.addEventListener("blur", () => {
        el.contentEditable = false;
        onChange(el.textContent);
      });

      el.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          el.blur();
          event.preventDefault();
        }
      });

      return el;
    }

    function createDeleteButton(deleteAction) {
      const deleteButton = document.createElement("button");
      deleteButton.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
      deleteButton.style.backgroundColor = "#555555";
      deleteButton.style.color = "white";
      deleteButton.style.border = "none";
      deleteButton.style.borderRadius = "4px";
      deleteButton.style.cursor = "pointer";
      deleteButton.style.padding = "5px 10px";

      let confirmTimeout;
      let isConfirming = false;

      deleteButton.addEventListener("click", () => {
        if (isConfirming) {
          // Second click - perform deletion
          clearTimeout(confirmTimeout);
          deleteAction();
        } else {
          // First click - enter confirmation state
          isConfirming = true;
          deleteButton.innerHTML = 'Sure?';
          deleteButton.classList.add('delete-confirm');

          confirmTimeout = setTimeout(() => {
            // Reset after 5 seconds
            isConfirming = false;
            deleteButton.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
            deleteButton.classList.remove('delete-confirm');
          }, 5000);
        }
      });

      deleteButton.addEventListener("mouseover", () => {
        deleteButton.style.backgroundColor = "#000";
      });

      deleteButton.addEventListener("mouseout", () => {
        deleteButton.style.backgroundColor = "#555555";
      });

      return deleteButton;
    }

    function createProject(project) {
      const projectDiv = document.createElement("div");
      projectDiv.classList.add("project");

      const header = document.createElement("div");
      header.classList.add("project-header");
      header.style.justifyContent = "flex-end";

      const projectNameEl = createEditableElement(
        "div",
        project.name,
        (newName) => {
          project.name = newName;
          saveData();
        }
      );
      projectNameEl.style.flexGrow = "1";

      const collapseBtn = document.createElement("button");
      collapseBtn.classList.add("collapse-btn");
      collapseBtn.innerHTML = project.collapsed
        ? '<i class="fas fa-chevron-down"></i>'
        : '<i class="fas fa-chevron-up"></i>';
      collapseBtn.addEventListener("click", () => {
        project.collapsed = !project.collapsed;
        saveData();
        renderProjects();
      });

      const moveUpBtn = document.createElement("button");
      moveUpBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
      moveUpBtn.disabled = appData.indexOf(project) === 0;
      moveUpBtn.addEventListener("click", () => {
        const index = appData.indexOf(project);
        if (index > 0) {
          [appData[index], appData[index - 1]] = [
            appData[index - 1],
            appData[index],
          ];
          saveData();
          renderProjects();
        }
      });

      const moveDownBtn = document.createElement("button");
      moveDownBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
      moveDownBtn.disabled = appData.indexOf(project) === appData.length - 1;
      moveDownBtn.addEventListener("click", () => {
        const index = appData.indexOf(project);
        if (index < appData.length - 1) {
          [appData[index], appData[index + 1]] = [
            appData[index + 1],
            appData[index],
          ];
          saveData();
          renderProjects();
        }
      });

      const deleteProjectButton = createDeleteButton(() => {
        appData = appData.filter((p) => p.id !== project.id);
        saveData();
        renderProjects();
      });

      header.appendChild(projectNameEl);
      [collapseBtn, moveUpBtn, moveDownBtn, deleteProjectButton].forEach(
        (btn) => {
          btn.style.marginLeft = "5px";
          header.appendChild(btn);
        }
      );

      const listsContainer = document.createElement("div");
      listsContainer.classList.add("lists-container");
      if (project.collapsed) listsContainer.style.display = "none";

      project.lists.forEach((list, index) =>
        createList(project, list, listsContainer, index, project.lists.length)
      );

      const addListDiv = document.createElement("div");
      addListDiv.classList.add("add-list");
      addListDiv.textContent = "Add List";
      addListDiv.addEventListener("click", () => {
        const newList = { id: Date.now(), name: "New List", items: [] };
        project.lists.push(newList);
        saveData();
        renderProjects();
      });

      listsContainer.appendChild(addListDiv);

      projectDiv.appendChild(header);
      projectDiv.appendChild(listsContainer);
      projectsContainer.appendChild(projectDiv);
    }

    function createList(project, list, container, index, totalLists) {
      const listDiv = document.createElement("div");
      listDiv.classList.add("list");

      const header = document.createElement("div");
      header.classList.add("list-header");

      const listNameEl = createEditableElement(
        "div",
        list.name,
        (newName) => {
          list.name = newName;
          saveData();
        }
      );
      listNameEl.style.flexGrow = "1";

      const deleteListButton = createDeleteButton(() => {
        project.lists = project.lists.filter((l) => l.id !== list.id);
        saveData();
        renderProjects();
      });

      const rearrangeButtons = document.createElement("div");
      rearrangeButtons.classList.add("rearrange-buttons");

      if (index > 0) {
        const movePrevBtn = document.createElement("button");
        movePrevBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
        movePrevBtn.addEventListener("click", () => {
          [project.lists[index], project.lists[index - 1]] = [
            project.lists[index - 1],
            project.lists[index],
          ];
          saveData();
          renderProjects();
        });
        rearrangeButtons.appendChild(movePrevBtn);
      }

      if (index < totalLists - 1) {
        const moveNextBtn = document.createElement("button");
        moveNextBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
        moveNextBtn.addEventListener("click", () => {
          [project.lists[index], project.lists[index + 1]] = [
            project.lists[index + 1],
            project.lists[index],
          ];
          saveData();
          renderProjects();
        });
        rearrangeButtons.appendChild(moveNextBtn);
      }

      header.appendChild(rearrangeButtons);
      header.appendChild(listNameEl);

      const addTodoButton = document.createElement("button");
      addTodoButton.innerHTML = '<i class="fa-regular fa-square-check"></i>';
      addTodoButton.addEventListener("click", () => {
        const newItem = {
          id: Date.now(),
          name: "New ToDo",
          type: "todo",
          completed: false,
        };
        list.items.push(newItem);
        saveData();
        renderProjects();
      });

      const addNoteButton = document.createElement("button");
      addNoteButton.innerHTML = '<i class="fa-regular fa-note-sticky"></i>';
      addNoteButton.addEventListener("click", () => {
        const newItem = { id: Date.now(), name: "New Note", type: "note" };
        list.items.push(newItem);
        saveData();
        renderProjects();
      });

      header.appendChild(addTodoButton);
      header.appendChild(addNoteButton);
      header.appendChild(deleteListButton);

      const listItemsContainer = document.createElement("div");
      listItemsContainer.classList.add("list-items");

      // Add drag and drop handlers for the list container
      listItemsContainer.addEventListener("dragover", (e) => {
        e.preventDefault();
        const draggingItem = document.querySelector(".dragging");
        if (!draggingItem) return;

        // If the container is empty or we're hovering at the bottom
        const items = Array.from(listItemsContainer.children);
        const lastItem = items[items.length - 1];

        if (!items.length || (lastItem && e.clientY > lastItem.getBoundingClientRect().bottom)) {
          removePlaceholders();
          const placeholder = createPlaceholder();
          listItemsContainer.appendChild(placeholder);
        }
      });

      listItemsContainer.addEventListener("dragleave", () => {
        listItemsContainer.classList.remove("drop-highlight");
      });

      listItemsContainer.addEventListener("drop", (e) => {
        e.preventDefault();

        try {
          const { itemId, listId } = JSON.parse(e.dataTransfer.getData("text/plain"));

          // Find source list and item
          const sourceList = appData
            .flatMap(p => p.lists)
            .find(l => l.id === listId);
          const draggedItem = sourceList.items.find(i => i.id === itemId);

          if (!draggedItem) return;

          // Remove item from source list
          sourceList.items = sourceList.items.filter(i => i.id !== itemId);

          // Find the insertion point based on the placeholder position
          const placeholder = listItemsContainer.querySelector('.drop-placeholder');
          if (placeholder) {
            const items = Array.from(listItemsContainer.children);
            const placeholderIndex = items.indexOf(placeholder);
            // If placeholder exists, insert at its position
            list.items.splice(placeholderIndex, 0, draggedItem);
          } else {
            // If no placeholder (empty list), add to the end
            list.items.push(draggedItem);
          }

          saveData();
          renderProjects();
        } catch (err) {
          console.error("Error during drag and drop:", err);
        }
      });

      // Ensure list.items exists
      if (!list.items) list.items = [];

      list.items.forEach((item) => createListItem(list, item, listItemsContainer));

      listDiv.appendChild(header);
      listDiv.appendChild(listItemsContainer);
      container.appendChild(listDiv);
    }

    function createListItem(list, item, container) {
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("list-item");
      itemDiv.setAttribute("draggable", "true");

      if (item.type === "todo") {
        itemDiv.classList.add("todo-item");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = item.completed;
        checkbox.classList.add("todo-checkbox");
        checkbox.addEventListener("change", () => {
          item.completed = checkbox.checked;
          itemNameEl.classList.toggle("strikethrough", item.completed);
          saveData();
        });

        const itemNameEl = createEditableElement(
          "div",
          item.name,
          (newName) => {
            item.name = newName;
            saveData();
          }
        );
        itemNameEl.classList.add("item-name");
        if (item.completed) {
          itemNameEl.classList.add("strikethrough");
        }

        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(itemNameEl);
      } else {
        const itemNameEl = createEditableElement(
          "div",
          item.name,
          (newName) => {
            item.name = newName;
            saveData();
          }
        );
        itemDiv.appendChild(itemNameEl);
      }

      const deleteItemButton = createDeleteButton(() => {
        list.items = list.items.filter((i) => i.id !== item.id);
        saveData();
        renderProjects();
      });

      itemDiv.appendChild(deleteItemButton);
      container.appendChild(itemDiv);

      // Updated drag and drop handlers
      itemDiv.addEventListener("dragstart", (e) => {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", JSON.stringify({
          itemId: item.id,
          listId: list.id
        }));
        itemDiv.classList.add("dragging");

        // Remove any existing placeholders
        removePlaceholders();
      });

      itemDiv.addEventListener("dragend", () => {
        itemDiv.classList.remove("dragging");
        // Remove any existing placeholders and shift classes
        removePlaceholders();
        document.querySelectorAll('.shift-up, .shift-down').forEach(el => {
          el.classList.remove('shift-up', 'shift-down');
        });
      });

      itemDiv.addEventListener("dragover", (e) => {
        e.preventDefault();
        const draggingItem = document.querySelector(".dragging");
        if (!draggingItem || draggingItem === itemDiv) return;

        removePlaceholders();

        const rect = itemDiv.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;

        if (e.clientY < midY) {
          // Insert placeholder before this item
          const placeholder = createPlaceholder();
          itemDiv.before(placeholder);
          // Shift this and following items down
          itemDiv.classList.add('shift-down');
        } else {
          // Insert placeholder after this item
          const placeholder = createPlaceholder();
          itemDiv.after(placeholder);
          // Shift following items down
          const nextSibling = itemDiv.nextElementSibling;
          if (nextSibling && !nextSibling.classList.contains('drop-placeholder')) {
            nextSibling.classList.add('shift-down');
          }
        }
      });

      itemDiv.addEventListener("dragleave", () => {
        itemDiv.classList.remove("drop-highlight-top", "drop-highlight-bottom");
      });

      itemDiv.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation(); // Prevent event from bubbling to container

        try {
          const { itemId, listId } = JSON.parse(e.dataTransfer.getData("text/plain"));

          // Find source list and item
          const sourceList = appData
            .flatMap(p => p.lists)
            .find(l => l.id === listId);
          const draggedItem = sourceList.items.find(i => i.id === itemId);

          if (!draggedItem || draggedItem.id === item.id) return;

          // Remove item from source list
          sourceList.items = sourceList.items.filter(i => i.id !== itemId);

          // Find target position and insert
          const targetIndex = list.items.indexOf(item);
          const rect = itemDiv.getBoundingClientRect();
          const dropPosition = e.clientY < rect.top + rect.height / 2 ? targetIndex : targetIndex + 1;

          list.items.splice(dropPosition, 0, draggedItem);
          saveData();
          renderProjects();
        } catch (err) {
          console.error("Error during drag and drop:", err);
        }
      });

      container.appendChild(itemDiv);
    }

    function createPlaceholder() {
      const placeholder = document.createElement('div');
      placeholder.classList.add('drop-placeholder');
      return placeholder;
    }

    function removePlaceholders() {
      document.querySelectorAll('.drop-placeholder').forEach(el => el.remove());
    }

    function renderProjects() {
      projectsContainer.innerHTML = "";
      appData.forEach((project) => createProject(project));
    }

    addProjectBtn.addEventListener("click", () => {
      const newProject = { id: Date.now(), name: "New Project", lists: [] };
      appData.push(newProject);
      saveData();
      renderProjects();
    });

    importDataBtn.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";

      input.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);
              if (Array.isArray(importedData)) {
                appData = importedData;
                saveData();
                renderProjects();
                alert("Data successfully imported!");
              } else {
                alert(
                  "Invalid file format. Please upload a valid JSON file."
                );
              }
            } catch (error) {
              alert("Failed to read file. Ensure it is a valid JSON file.");
            }
          };
          reader.readAsText(file);
        }
      });

      input.click();
    });

    exportDataBtn.addEventListener("click", () => {
      const data = JSON.stringify(appData, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kanban-data.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Add this function to handle theme switching
    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      currentTheme = theme;
      themeToggleBtn.innerHTML = theme === "dark" 
        ? '<i class="fas fa-sun"></i>' 
        : '<i class="fas fa-moon"></i>';
    }

    // Initialize theme
    setTheme(currentTheme);

    // Add event listener for theme toggle
    themeToggleBtn.addEventListener("click", () => {
      const newTheme = currentTheme === "light" ? "dark" : "light";
      setTheme(newTheme);
    });

    renderProjects();
  </script>
</body>

</html>