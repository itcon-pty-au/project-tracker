<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.css" />
  <script src="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <script type="text/javascript" src="https://unpkg.com/moment/min/moment.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/vis-data/peer/umd/vis-data.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/vis-timeline/peer/umd/vis-timeline-graph2d.min.js"></script>
  <link href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />

  <script>
    const { Timeline, DataSet } = vis;
  </script>

  <style>
    :root {
      --bg-color: #f4f4f4;
      --text-color: #000000;
      --card-bg: #ffffff;
      --item-bg: #e9ecef;
      --item-hover: #dee2e6;
      --border-color: #ddd;
      --header-bg: #f8f9fa;
      --project-bg-1: #f0f0f0;
      --project-bg-2: #f0f0f0;
      --date-scheme: light;
      --date-picker-filter: none;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --card-bg: #2d2d2d;
      --item-bg: #3d3d3d;
      --item-hover: #4d4d4d;
      --border-color: #404040;
      --header-bg: #2a2a2a;
      --project-bg-1: #1a1a1a;
      --project-bg-2: #1a1a1a;
      --date-scheme: dark;
      --date-picker-filter: invert(1);
    }

    [data-theme="light"] {
      --date-scheme: light;
    }

    .editable {
      border: none;
      outline: none;
      min-width: 50px;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      font-size: 16px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .container {
      padding: 15px;
      display: flex;
      flex-direction: column;
      min-height: 97vh;
    }

    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .top-menu button {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .projects-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
      flex: 1; 
    }

    .project {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      background-color: var(--card-bg);
      display: flex;
      flex-direction: column;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .project-header .editable {
      cursor: pointer;
      border: none;
      background-color: transparent;
      font-size: 1.2em;
      padding: 5px;
      outline: none;
      transition: border-bottom 0.2s;
    }

    .lists-container {
      display: flex;
      gap: 15px;
      padding-top: 10px;
    }

    .highlight {
      background-color: #f0f8ff;
    }

    .list {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--card-bg);
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--header-bg);
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      gap: 5px;
      position: relative;
    }

    .list-header .rearrange-buttons {
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      gap: 5px;
      color: var(--text-color);
      opacity: 0.5;
      font-size: 0.9em;
      align-items: center;
      position: absolute;
      left: 10px;
      z-index: 1;
      width: 40px;
    }

    .list-header:hover .rearrange-buttons {
      opacity: 1;
    }

    .rearrange-buttons i {
      padding: 4px;
      transition: opacity 0.2s ease;
    }

    .rearrange-buttons i:hover {
      opacity: 1;
    }

    .list-items {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .list-item {
      background-color: var(--item-bg);
      padding: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
      cursor: move;
      position: relative;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .list-item:hover {
      background-color: var(--item-hover);
    }

    .drop-highlight {
      background-color: #f0f8ff;
    }

    .list-item.todo-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .list-item.todo-item .item-name {
      flex: 1;
    }

    .list-item.todo-item .item-name.strikethrough {
      text-decoration: line-through;
      color: gray;
    }

    .add-item-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .add-item {
      cursor: pointer;
      background: none;
      text-align: center;
      padding: 10px;
      border: dashed 1px;
      border-radius: 5px;
      color: #6c757d;
      flex: 1;
    }

    .add-item:hover {
      background-color: var(--item-hover);
    }

    .add-list {
      cursor: pointer;
      background: none;
      text-align: center;
      padding: 10px;
      border: dashed 1px;
      border-radius: 5px;
      color: #6c757d;
    }

    .add-list:hover {
      background-color: var(--item-hover);
    }

    .dragging {
      opacity: 0.5;
      cursor: move;
    }

    .drop-placeholder {
      height: 2px;
      background-color: var(--text-color);
      margin: 10px 0;
      transition: all 0.2s ease;
      position: relative;
      opacity: 0.3;
      border-radius: 1px;
    }

    .drop-placeholder::before,
    .drop-placeholder::after {
      content: "";
      position: absolute;
      width: 6px;
      height: 6px;
      background-color: var(--text-color);
      border-radius: 50%;
      top: -2px;
      opacity: 0.3;
    }

    .drop-placeholder::before {
      left: -3px;
    }

    .drop-placeholder::after {
      right: -3px;
    }

    .list-items {
      min-height: 50px;

      padding: 10px;
    }

    .list-item.shift-up {
      transform: translateY(-100%);
      transition: transform 0.2s ease;
    }

    .list-item.shift-down {
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }

    .delete-confirm:hover {
      background-color: #000 !important;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }

      100% {
        opacity: 1;
      }
    }

    .todo-checkbox {
      accent-color: #28a745;
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .list-item button {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .list-item:hover button {
      opacity: 1;
    }

    #themeToggleBtn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #themeToggleBtn:hover {
      background-color: #000;
    }

    [data-theme="dark"] #themeToggleBtn:hover {
      background-color: #666;
    }

    .item-hover-menu {
      position: absolute;
      top: -20px;
      right: 10px;
      background-color: var(--card-bg);
      padding: 3px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: none;
      gap: 5px;
      z-index: 100;
      align-items: center;
      transition: width 0.2s ease;
    }

    .item-hover-menu button {
      padding: 3px 6px;
      background-color: var(--item-bg);
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      transition: width 0.2s ease;
    }

    .item-hover-menu button.delete-confirm {
      width: auto;
      padding: 3px 10px;
      white-space: nowrap;
    }

    .list-item:hover .item-hover-menu {
      display: flex;
    }

    .item-hover-menu input[data-coloris] {
      position: absolute;
      visibility: hidden;
      width: 0 !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      border: none !important;
      pointer-events: none;
      opacity: 0;
    }

    .item-hover-menu button:hover {
      background-color: var(--item-hover);
    }

    .item-hover-menu button i {
      font-size: 14px;
    }

    .item-hover-menu button[data-coloris] {
      padding: 3px 6px !important;
      width: 28px !important;
      height: 28px !important;
      background-color: var(--item-bg) !important;
    }

    .add-list {
      display: none;
    }

    .add-list-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .add-list-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .add-list-btn:hover {
      background-color: #666;
    }

    .project-header button,
    .list-header button {
      padding: 5px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;  /* Reduced from 32px */
      height: 28px;  /* Reduced from 32px */
      margin-left: 5px;
      transition: width 0.2s ease;
    }

    .project-header button i,
    .list-header button i {
      font-size: 12px;  /* Reduced from 14px */
    }

    .project-header button.delete-confirm,
    .list-header button.delete-confirm {
      width: auto;
      padding: 5px 8px;  /* Reduced horizontal padding */
      font-size: 12px;  /* Added to match icon size */
    }

    .project-header button:hover,
    .list-header button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .project-header button:hover,
    [data-theme="dark"] .list-header button:hover {
      background-color: #666;
    }

    .list.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .top-menu button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .top-menu button:hover {
      background-color: #666;
    }

    #coffeeBtn {
      color: #fff;
      text-decoration: none;
      display: inline-block;
    }

    .rearrange-buttons {
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      gap: 5px;
      color: var(--text-color);
      opacity: 0.5;
      font-size: 0.9em;
      position: relative;
      margin-right: 8px;
    }

    .list-header {
      position: relative;
    }

    .list-header:hover .rearrange-buttons {
      opacity: 1;
    }

    button:disabled {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }

    .editor-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      backdrop-filter: blur(3px);
    }

    .editor-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      height: 90vh;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 0 0 1px var(--border-color),
                  0 4px 20px rgba(0, 0, 0, 0.15),
                  0 12px 40px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-popup .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--header-bg);
      border-radius: 12px 12px 0 0;
    }

    .editor-popup .due-date-container {
      border-bottom: 1px solid var(--border-color);
      background: var(--header-bg);
    }

    [data-theme="dark"] .editor-popup {
      box-shadow: 0 0 0 1px var(--border-color),
                  0 4px 20px rgba(0, 0, 0, 0.3),
                  0 12px 40px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .editor-overlay {
      background: rgba(0, 0, 0, 0.7);
    }

    .editor-popup #summernote {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .editor-popup .note-editor {
      display: flex !important;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      width: 100%;
      overflow: hidden;
    }

    .editor-popup .note-editing-area {
      flex: 1;
      display: flex !important;
      flex-direction: column;
      min-height: 0 !important;
    }

    .editor-popup .note-editable {
      flex: 1 !important;
      min-height: 0 !important;
      height: 100% !important;
    }

    .editor-popup .editor-header .close-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .editor-popup .editor-header .close-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .editor-popup .editor-header .close-btn:hover {
      background-color: #666;
    }

    .editor-popup .editor-header .close-btn i {
      font-size: 14px;
    }

    .note-editor .note-editable {
      background-color: var(--card-bg) !important;
      color: var(--text-color) !important;
    }

    .note-editor .note-toolbar {
      background-color: var(--header-bg) !important;
      border-color: var(--border-color) !important;
    }

    .note-editor .note-toolbar .note-btn:not(.note-color-btn) {
      background-color: var(--item-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-color) !important;
    }

    .note-editor .note-color-palette .note-color-row .note-color-btn {
      width: 20px !important;
      height: 20px !important;
      padding: 0 !important;
      margin: 2px !important;
      border: 1px solid var(--border-color) !important;
    }

    .note-editor .note-color-palette .note-color-row .note-color-btn:hover {
      border-color: #000 !important;
    }

    [data-theme="dark"] .note-editor .note-color-palette .note-color-row .note-color-btn:hover {
      border-color: #fff !important;
    }

    .note-editor .note-color-palette {
      padding: 5px !important;
      background-color: var(--card-bg) !important;
    }

    .note-editor .note-color-reset {
      padding: 5px 8px !important;
      margin: 5px !important;
      width: calc(100% - 10px) !important;
      background-color: var(--item-bg) !important;
      color: var(--text-color) !important;
      border: 1px solid var(--border-color) !important;
    }

    .note-editor .note-color-reset:hover {
      background-color: var(--item-hover) !important;
    }

    .note-editor.note-frame {
      display: flex !important;
      flex-direction: column;
      height: 100% !important;
      min-height: 0 !important;
    }

    .note-editor .note-status-output,
    .note-editor .note-statusbar {
      background-color: var(--header-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-color) !important;
      display: none !important;
    }

    .note-editor .note-dropdown-menu {
      background-color: var(--card-bg) !important;
      border-color: var(--border-color) !important;
    }

    .note-editor .note-dropdown-item {
      color: var(--text-color) !important;
    }

    .note-editor .note-dropdown-item:hover {
      background-color: var(--item-hover) !important;
    }

    [data-coloris] {
      padding: 5px !important;
      width: auto !important;
      height: auto !important;
      border: none !important;
      background: none !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    [data-coloris]::before {
      display: none !important;
    }

    .color-picker-btn .fa-paintbrush {
      font-size: 14px !important;
      color: var(--text-color) !important;
      display: inline-block !important;
      pointer-events: none !important;
    }

    .item-link {
      color: #0066cc;
      text-decoration: underline;
      cursor: pointer;
    }

    .item-link:hover {
      color: #0052a3;
    }

    [contenteditable="true"] .item-link {
      color: inherit;
      text-decoration: none;
      cursor: text;
    }

    .sub-list {
      margin: 10px 0;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--card-bg);
      overflow: hidden;
      cursor: move;
    }

    .sub-list.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .sub-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
    }

    .sub-list-header button {
      padding: 5px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;  /* Reduced from 32px */
      height: 28px;  /* Reduced from 32px */
      margin-left: 5px;
      transition: width 0.2s ease;
    }

    .sub-list-header button i {
      font-size: 12px;  /* Reduced from 14px */
    }

    .sub-list-header button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .sub-list-header button:hover {
      background-color: #666;
    }

    .sub-list-header button.delete-confirm {
      width: auto;
      padding: 5px 8px;  /* Reduced horizontal padding */
      font-size: 12px;  /* Added to match icon size */
    }

    .sub-list-items {
      padding: 10px;
      min-height: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sub-list-item {
      background-color: var(--item-bg);
      padding: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
      cursor: move;

      position: relative;
    }

    .sub-list-item:hover {
      background-color: var(--item-hover);
    }

    .sub-list-item.todo-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .sub-list-item.todo-item .item-name {
      flex: 1;
    }

    .sub-list-item.todo-item .item-name.strikethrough {
      text-decoration: line-through;
      color: gray;
    }

    .sub-list-item.shift-up {
      transform: translateY(-100%);
      transition: transform 0.2s ease;
    }

    .sub-list-item.shift-down {
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }

    .sub-list-item.drop-highlight {
      background-color: #f0f8ff;
    }

    .sub-list-item.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .sub-list-item.drop-placeholder {
      height: 2px;
      background-color: #555555;
      margin: 10px 0;
      transition: all 0.2s ease;
      position: relative;
    }

    .sub-list-item.drop-placeholder::before {
      content: "";
      position: absolute;
      left: -5px;
      top: -4px;
      width: 10px;
      height: 10px;
      background-color: #555555;
      border-radius: 50%;
    }

    .sub-list-item.drop-placeholder::after {
      content: "";
      position: absolute;
      right: -5px;
      top: -4px;
      width: 10px;
      height: 10px;
      background-color: #555555;
      border-radius: 50%;
    }

    .time-tracker {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 5px;
    }

    .elapsed-time {
      min-width: 60px;
      font-family: monospace;
      font-size: 0.9em;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .history-table th,
    .history-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid var(--border-color);
    }

    .history-table th {
      background-color: var(--header-bg);
    }

    .history-search {
      width: calc(100% - 16px);
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
    }

    .history-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 1000px;
      height: 80%;
      background: var(--card-bg);
      z-index: 1000;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
    }

    .history-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .history-modal .close-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .history-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .history-modal .cleanup-btn {
      padding: 5px 10px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    .history-modal .cleanup-btn:hover {
      background-color: #bd2130;
    }

    .projects-container .project:nth-child(odd) {
      background-color: var(--project-bg-1);
    }

    .projects-container .project:nth-child(even) {
      background-color: var(--project-bg-2);
    }

    .timeline-container {
      margin: 15px 0;
      background-color: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .timeline {
      height: 100px;
      background-color: var(--card-bg);
    }

    .vis-timeline {
      border: none;
      background-color: var(--card-bg);
    }

    .vis-item {
      background-color: var(--item-bg);
      border-color: var(--border-color);
      color: var(--text-color);
      border-width: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .vis-item.vis-selected {
      background-color: var(--item-bg);
      border-color: var(--border-color);
    }

    .vis-item:hover {
      background-color: var(--item-bg);
      border-color: var(--border-color);
    }

    .vis-tooltip {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-color);
      padding: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .vis-time-axis .vis-text {
      color: var(--text-color);
    }

    .vis-time-axis .vis-grid.vis-minor {
      border-color: var(--border-color);
      opacity: 0.8;
      height: 30px !important;
    }

    .project-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      width: 80%;
      max-width: 600px;
    }

    .project-form input[type="text"],
    .project-form input[type="date"] {
      width: calc(100% - 24px);
      padding: 8px 12px;
      margin: 5px 0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
    }

    .milestones-container {
      margin: 15px 0;
    }

    .milestone-entry {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .milestone-entry input {
      flex: 1;
    }

    .form-buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 0;
      gap: 10px;
    }

    .form-buttons button {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .form-buttons button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .form-buttons button:hover {
      background-color: #666;
    }

    .form-buttons button i {
      font-size: 14px;
    }

    .remove-milestone-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .remove-milestone-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .remove-milestone-btn:hover {
      background-color: #666;
    }

    .remove-milestone-btn i {
      font-size: 14px;
    }

    .form-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .timeline-delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      z-index: 10;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease, width 0.2s ease,
        background-color 0.2s ease;
      opacity: 0;
    }

    .timeline-container:hover .timeline-delete-btn {
      opacity: 1;
    }

    .timeline-delete-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .timeline-delete-btn:hover {
      background-color: #666;
    }

    .timeline-delete-btn.delete-confirm {
      width: auto;
      opacity: 1;
      padding: 5px 10px;
    }

    .vis-time-axis .vis-text {
      color: var(--text-color);
      opacity: 0.4;
    }

    .vis-time-axis .vis-grid.vis-major {
      border-color: var(--border-color);
      opacity: 0.7;
      border-width: 3px;
      height: 100% !important;
    }

    .vis-item-content {
      position: relative;
      color: var(--text-color);
      opacity: 0.8;
      font-size: 0.9em;
      padding: 2px 5px;
      transition: opacity 0.2s ease;
    }

    .vis-item:hover {
      opacity: 1;
    }

    .timeline {
      height: 100px;
      background-color: var(--card-bg);
      width: 100%;
      overflow-x: hidden;
    }

    .vis-time-axis .vis-grid.vis-minor {
      border-color: var(--border-color);
      opacity: 0.4;
    }

    .vis-time-axis .vis-grid.vis-major {
      border-color: var(--border-color);
      opacity: 0.7;
      border-width: 3px;
      height: 100% !important;
    }

    .vis-item {
      z-index: 2;
    }

    [data-theme="dark"] .vis-time-axis .vis-grid.vis-minor {
      opacity: 0.8;
    }

    [data-theme="dark"] .vis-time-axis .vis-grid.vis-major {
      opacity: 0.7;
    }

    .vis-current-time {
      background-color: #ff4444;
      width: 2px;
      z-index: 1;
    }

    .vis-item.vis-dot {
      display: none !important;
    }

    .vis-item.vis-point {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
    }

    .timeline-delete-btn i {
      font-size: 14px;
    }

    .project-form input[type="date"] {
      color-scheme: var(--date-scheme);
    }

    [data-theme="dark"] {
      --date-scheme: dark;
    }

    [data-theme="light"] {
      --date-scheme: light;
    }

    .milestones-container h3 {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .add-milestone-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .add-milestone-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .add-milestone-btn:hover {
      background-color: #666;
    }

    .add-milestone-btn i {
      font-size: 14px;
    }

    .project-form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .project-form-header .form-buttons {
      margin-top: 0;
    }

    .remove-milestone {
      color: var(--text-color);
      opacity: 0.5;
      cursor: pointer;
      font-size: 18px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-milestone:hover {
      opacity: 1;
    }

    .note-editor .note-color-palette .note-color-row .note-color-btn {
      width: 20px !important;
      height: 20px !important;
      padding: 0 !important;
      margin: 2px !important;
    }

    .note-editor .note-color-palette {
      padding: 5px !important;
    }

    .note-editor .note-color-reset {
      padding: 5px 8px !important;
      margin: 5px !important;
      width: calc(100% - 10px) !important;
      background-color: var(--item-bg) !important;
      color: var(--text-color) !important;
      border: 1px solid var(--border-color) !important;
    }

    .note-editor .note-color-reset:hover {
      background-color: var(--item-hover) !important;
    }

    @keyframes pulseButton {
      0% {
        transform: scale(1);
        background-color: #ff4444;
      }

      50% {
        transform: scale(1.05);
        background-color: #ff0000;
      }

      100% {
        transform: scale(1);
        background-color: #ff4444;
      }
    }

    #autoBackupBtn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #autoBackupBtn.needs-backup {
      animation: pulseButton 2s infinite;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }

    .logo {
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo h1 {
      font-size: 1.2em;
      font-weight: 700;
      margin: 0;
      color: var(--text-color);
      letter-spacing: 0;
    }

    .logo .tagline {
      font-size: 0.8em;
      color: var(--text-color);
      opacity: 0.7;
      font-style: italic;
      margin-top: 2px;
    }

    .top-menu-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      align-items: center;
    }

    .footer {
      text-align: center;
      padding: 10px 0;
      margin-top: auto;
      color: var(--text-color);
      opacity: 0.7;
      font-size: 0.9em;
      border-top: 1px solid var(--border-color);
    }

    .footer .heart {
      color: #ff4444;
      display: inline-block;
      font-size: 1.5em;
      position: relative;
      top: 2px;
      animation: heartbeat 1.5s ease infinite;
    }

    @keyframes heartbeat {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    .rearrange-buttons i {
      padding: 4px;
      transition: opacity 0.2s ease;
    }

    .rearrange-buttons i:hover {
      opacity: 1;
    }

    .list-header-content {
      display: flex;
      align-items: center;
      flex: 1;
      margin-left: 50px;
    }

    .list-header .editable {
      flex: 1;
      min-width: 0;
    }

    .list:first-child .list-header .rearrange-buttons {
      width: 20px;
    }

    .list:last-child .list-header .rearrange-buttons {
      width: 20px;
    }

    .list:first-child .list-header-content {
      margin-left: 30px;
    }

    .list:last-child .list-header-content {
      margin-left: 30px;
    }

    .rearrange-buttons i {
      padding: 4px;
      transition: opacity 0.2s ease;
      width: 16px;
      text-align: center;
    }

    .backup-nudge {
      animation: nudge 1s ease-in-out infinite;
      position: relative;
      background-color: #ffd700 !important;
      color: black !important;
    }

    @keyframes nudge {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-3px);
      }

      75% {
        transform: translateX(3px);
      }
    }

    .read-more-btn {
      margin-left: 8px;
      padding: 2px 6px;
      font-size: 0.8em;
      background-color: var(--item-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
    }

    .read-more-btn:hover {
      background-color: var(--item-hover);
    }

    .history-table td {
      max-width: 400px;
      vertical-align: top;
    }

    .delete-history-btn {
      margin-left: 8px;
      padding: 2px 6px;
      font-size: 0.8em;
      background-color: transparent;
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }

    .delete-history-btn:hover {
      opacity: 1;
      color: #ff4444;
    }

    .history-table td {
      position: relative;
    }

    .history-table tr:hover .delete-history-btn {
      opacity: 0.8;
    }

    .action-column {
      width: 50px;
      text-align: center;
    }

    .delete-history-btn {
      padding: 4px 8px;
      font-size: 0.9em;
      background-color: transparent;
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }

    .delete-history-btn:hover {
      opacity: 1;
      color: #ff4444;
    }

    .history-table tr:hover .delete-history-btn {
      opacity: 0.8;
    }

    .due-date-container {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px 20px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
      margin: 0;
    }

    .due-date-container label {
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.8;
    }

    .due-date-container input[type="date"] {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
      color-scheme: var(--date-scheme);
      font-size: 14px;
    }

    .due-date-container input[type="date"]::-webkit-calendar-picker-indicator {
      filter: var(--date-picker-filter);
      cursor: pointer;
      padding: 4px;
      margin-right: -4px;
      opacity: 0.7;
      color: var(--text-color);
    }

    .list-item.due-soon {
      position: relative;
      overflow: visible;
    }

    .list-item.due-soon::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      width: 12px;
      height: 12px;
      background-color: #ffd700;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
      z-index: 2;
    }

    .list-item.overdue {
      position: relative;
      overflow: visible;
    }

    .list-item.overdue::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      width: 12px;
      height: 12px;
      background-color: #ff4444;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 68, 68, 0.8);
      z-index: 2;
    }

    .due-date-info {
      margin-left: 8px;
      font-size: 0.85em;
      opacity: 0.9;
      font-style: italic;
      background: rgba(0, 0, 0, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      display: inline-block;
    }

    .list-item.due-soon .due-date-info {
      color: #ffd700;
      font-weight: bold;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
    }

    .list-item.overdue .due-date-info {
      color: #ff4444;
      font-weight: bold;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
    }

    .task-content {
      display: inline-block;
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }
    
    .truncated-text {
      display: inline;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .full-text {
      display: none;
    }

    .history-table td {
      word-break: break-word;
      line-height: 1.4;
    }

    .history-table .read-more-btn {
      background: none;
      border: none;
      color: #0066cc;
      cursor: pointer;
      padding: 0;
      font-size: 0.9em;
      margin-left: 5px;
    }

    .history-table .read-more-btn:hover {
      text-decoration: underline;
    }

    .note-editor .note-statusbar {
      display: none !important;
    }

    .note-editor.note-frame {
      height: calc(100% - 50px) !important;
    }

    .note-editing-area {
      height: calc(100% - 40px) !important;
    }

    .note-editable {
      height: 100% !important;
      min-height: unset !important;
    }

    .note-editing-area:focus-within {
      outline: none !important;
    }

    .note-editable:focus {
      outline: none !important;
    }

    .note-editor .note-editing-area .note-editable {
      outline: none !important;
      border: none !important;
    }

    .note-editor *:focus,
    .note-editor *:focus-within,
    .note-editor .note-editable,
    .note-editor .note-editing-area,
    .note-frame *,
    .note-frame *:focus,
    .note-frame *:focus-within {
      outline: none !important;
      border-color: transparent !important;
    }

    .note-placeholder,
    .note-editable {
      border: none !important;
      box-shadow: none !important;
    }

    .note-editor .note-dropzone {
      display: none !important;
    }

    @keyframes steam {
      0% {
        transform: translateY(0) translateX(-50%) scale(1);
        opacity: 0;
      }
      50% {
        transform: translateY(-10px) translateX(-40%) scale(1.2);
        opacity: 0.5;
      }
      100% {
        transform: translateY(-20px) translateX(-30%) scale(1.4);
        opacity: 0;
      }
    }

    @keyframes wiggle {
      0%, 100% {
        transform: rotate(0deg);
      }
      25% {
        transform: rotate(-8deg);
      }
      75% {
        transform: rotate(8deg);
      }
    }

    #coffeeBtn {
      position: relative;
    }

    #coffeeBtn button {
      transition: transform 0.3s ease;
    }

    #coffeeBtn button:hover {
      animation: wiggle 0.5s ease-in-out;
    }

    #coffeeBtn button::before {
      content: "~";
      position: absolute;
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      opacity: 0;
      color: var(--text-color);
    }

    #coffeeBtn button:hover::before {
      animation: steam 1s ease-in-out infinite;
    }

    #coffeeBtn button i {
      transition: transform 0.3s ease;
    }

    #coffeeBtn:hover button i {
      transform: rotate(-15deg);
    }

    .hide-back-button .introjs-prevbutton {
      display: none !important;
    }

    .hide-back-button .introjs-tooltipbuttons {
      text-align: right;
    }

    .welcome-step.introjs-tooltip {
      max-width: 500px !important;
      width: 90% !important;
    }

    .welcome-step .introjs-tooltiptext {
      padding: 20px !important;
      line-height: 1.6 !important;
      font-size: 1.1em !important;
    }

    .welcome-step .introjs-tooltip-title {
      font-size: 1.4em !important;
      padding: 20px 20px 0 20px !important;
    }

    .welcome-step .introjs-tooltipbuttons {
      padding: 20px !important;
    }

    .introjs-tooltip.welcome-step {
      max-width: 600px !important;
      width: 90% !important;
      min-width: 500px !important;
    }

    .welcome-step.introjs-tooltip .introjs-tooltiptext {
      padding: 24px !important;
      line-height: 1.6 !important;
      font-size: 1.1em !important;
      text-align: left !important;
    }

    .welcome-step.introjs-tooltip .introjs-tooltip-title {
      font-size: 1.5em !important;
      padding: 24px 24px 0 24px !important;
      margin-bottom: 12px !important;
    }

    .welcome-step.introjs-tooltip .introjs-tooltipbuttons {
      padding: 20px !important;
      border-top: 1px solid var(--border-color) !important;
    }

    .welcome-step.introjs-tooltip {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
    }

    @media (max-width: 600px) {
      .welcome-step.introjs-tooltip {
        min-width: unset !important;
        width: calc(100% - 40px) !important;
        margin: 0 20px !important;
      }
    }

    .introjs-tooltip.welcome-step {
      max-width: 600px !important;
      width: 90% !important;
      min-width: 500px !important;
      position: fixed !important;
      left: 50% !important;
      top: 50% !important;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
    }

    .welcome-step .introjs-arrow {
      display: none !important;
    }

    .welcome-step.introjs-tooltip:after,
    .welcome-step.introjs-tooltip:before {
      display: none !important;
    }

    .welcome-step .introjs-tooltiptext {
      text-align: center !important;
    }

    @media (max-width: 600px) {
      .introjs-tooltip.welcome-step {
        min-width: unset !important;
        width: calc(100% - 40px) !important;
        max-width: none !important;
      }
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="top-menu">
      <div class="logo">
        <h1>Taskan</h1>
        <span class="tagline">Organize. Track. Achieve.</span>
      </div>
      <div class="top-menu-buttons">
        <button id="addProjectBtn" title="Create New Project">
          New Project
        </button>
        <button id="importDataBtn" title="Import Data"><i class="fa-solid fa-file-import"></i></button>
        <button id="autoBackupBtn" title="Setup Auto-backup"><i class="fa-solid fa-file-export"></i></button>
        <button id="historyBtn" title="View Task History"><i class="fa fa-history"></i></button>
        <button id="themeToggleBtn" title="Toggle Theme">
          <i class="fas fa-sun"></i>
        </button>
        <a href="https://buymeacoffee.com/itcon" target="_blank" id="coffeeBtn">
          <button title="Buy me a coffee">
            <i class="fas fa-mug-hot"></i>
          </button>
        </a>
      </div>
    </div>
    <div id="projectsContainer" class="projects-container"></div>
    <div class="footer">
      ©
      <script>
        document.write(new Date().getFullYear());
      </script>
      ITCON • Made with <span class="heart">♥</span> in Melbourne
    </div>
  </div>

  <div class="editor-overlay"></div>
  <div class="editor-popup">
    <div class="editor-header">
      <h3>Edit Note</h3>
      <button class="close-btn"><i class="fas fa-times"></i></button>
    </div>
    <div class="due-date-container" style="display: none;">
      <label>Due Date:</label>
      <input type="date" id="dueDateInput">
      <button id="clearDueDate" title="Clear Due Date">
        <i class="fas fa-times"></i>
      </button>
      <span class="due-date-info"></span>
    </div>
    <div id="summernote"></div>
  </div>

  <div class="history-overlay"></div>
  <div class="history-modal">
    <div class="history-modal-header">
      <h3>Task History</h3>
      <div>
        <button class="cleanup-btn" title="Clear All History">
          <i class="fas fa-trash"></i> Clear History
        </button>
        <button class="close-btn"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <input type="text" class="history-search" placeholder="Search tasks..." />
    <table class="history-table">
      <thead>
        <tr>
          <th>Task</th>
          <th>Started At</th>
          <th>Completed At</th>
          <th>Time Taken</th>
          <th style="width: 50px">Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="form-overlay" style="display: none"></div>
  <div class="project-form" style="display: none">
    <div class="project-form-header">
      <h2>New Project</h2>
      <div class="form-buttons">
        <button class="submit-btn" title="Save Project">
          <i class="fa-solid fa-save"></i>
        </button>
        <button class="cancel-btn" title="Cancel">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>
    <div>
      <input type="text" id="projectName" placeholder="Enter project name" />
    </div>

    <div class="milestones-container">
      <h3>
        Milestones
        <button class="add-milestone-btn" title="Add Milestone">
          <i class="fa-solid fa-plus"></i>
        </button>
      </h3>
      <div id="milestoneEntries"></div>
    </div>
  </div>

  <script>
    const AUTO_BACKUP_KEY = "kanbanAutoBackupHandle";
    const BACKUP_INTERVAL = 1000 * 60 * 60;
    const LAST_BACKUP_KEY = "kanbanLastBackupTime";

    const projectsContainer = document.getElementById("projectsContainer");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const importDataBtn = document.getElementById("importDataBtn");
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    const historyBtn = document.getElementById("historyBtn");

    let appData = (() => {
      const backupConfig = localStorage.getItem(AUTO_BACKUP_KEY);
      const lastBackupTime = localStorage.getItem(LAST_BACKUP_KEY);

      const data = JSON.parse(localStorage.getItem("kanbanData")) || [];

      if (backupConfig) {
        localStorage.setItem(AUTO_BACKUP_KEY, backupConfig);
      }
      if (lastBackupTime) {
        localStorage.setItem(LAST_BACKUP_KEY, lastBackupTime);
      }

      return data;
    })();

    function saveData() {
      const backupConfig = localStorage.getItem(AUTO_BACKUP_KEY);
      const lastBackupTime = localStorage.getItem(LAST_BACKUP_KEY);

      localStorage.setItem("kanbanData", JSON.stringify(appData));

      if (backupConfig) {
        localStorage.setItem(AUTO_BACKUP_KEY, backupConfig);
      }
      if (lastBackupTime) {
        localStorage.setItem(LAST_BACKUP_KEY, lastBackupTime);
      }
    }

    let currentTheme = localStorage.getItem("theme") || "dark";
    let taskHistory = JSON.parse(localStorage.getItem("taskHistory")) || [];
    let activeTimers = new Map();

    function createEditableElement(tag, value, onChange) {
      const el = document.createElement(tag);
      el.classList.add("editable");
      el.innerHTML = value ? formatTextWithLinks(value) : "";

      el.contentEditable = false;

      el.addEventListener("dblclick", () => {
        makeEditable(el);
      });

      function makeEditable(element) {
        element.contentEditable = true;
        element.textContent = element.textContent || "";
        element.focus();

        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(element);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
      }

      el.addEventListener("blur", () => {
        el.contentEditable = false;
        let newValue = el.textContent.trim();

        if (!newValue) {
          newValue = "Untitled";
        }

        onChange(newValue);
        el.innerHTML = formatTextWithLinks(newValue);
      });

      if (!value) {
        setTimeout(() => {
          makeEditable(el);
        }, 0);
      }

      el.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          if (event.shiftKey) {
            event.preventDefault();
            document.execCommand("insertLineBreak");
          } else {
            event.preventDefault();
            el.blur();
          }
        }
      });

      return el;
    }

    function createDeleteButton(deleteAction) {
      const deleteButton = document.createElement("button");
      deleteButton.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
      deleteButton.title = "Delete";

      let confirmTimeout;
      let isConfirming = false;

      deleteButton.addEventListener("click", () => {
        if (isConfirming) {
          clearTimeout(confirmTimeout);
          deleteAction();
        } else {
          isConfirming = true;
          deleteButton.innerHTML = "Sure?";
          deleteButton.title = "Click again to confirm deletion";
          deleteButton.classList.add("delete-confirm");

          confirmTimeout = setTimeout(() => {
            isConfirming = false;
            deleteButton.innerHTML =
              '<i class="fa-regular fa-trash-can"></i>';
            deleteButton.title = "Delete";
            deleteButton.classList.remove("delete-confirm");
          }, 5000);
        }
      });

      return deleteButton;
    }

    function createProject(project, projectElement = document.createElement("div")) {
      projectElement.className = "project";
      projectElement.id = `project-${project.id}`;

      const header = document.createElement("div");
      header.className = "project-header";

      const projectName = createEditableElement("div", project.name, (newName) => {
        project.name = newName;
        saveData();
      });

      const buttonContainer = document.createElement("div");
      buttonContainer.style.display = "flex";
      buttonContainer.style.gap = "5px";
      const editButton = document.createElement("button");
      editButton.innerHTML = '<i class="fas fa-pen"></i>';
      editButton.title = "Edit Project";
      editButton.onclick = () => {
        const item = {
          id: Date.now(),
          type: "project",
          content: project.name,
          isNew: false
        };
        showProjectForm(project);
      };

      const addListButton = document.createElement("button");
      addListButton.className = "add-list-btn";
      addListButton.innerHTML = '<i class="fas fa-plus"></i>';
      addListButton.title = "Add List";
      addListButton.onclick = () => {
        const newList = { id: Date.now(), name: "", items: [] };
        project.lists.push(newList);
        saveData();
        renderSingleProject(project);
      };

      const collapseBtn = document.createElement("button");
      collapseBtn.innerHTML = project.collapsed ? 
        '<i class="fas fa-chevron-down"></i>' : 
        '<i class="fas fa-chevron-up"></i>';
      collapseBtn.title = project.collapsed ? "Expand" : "Collapse";
      collapseBtn.onclick = () => {
        project.collapsed = !project.collapsed;
        saveData();
        renderSingleProject(project);
      };

      const moveUpBtn = document.createElement("button");
      moveUpBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
      moveUpBtn.title = "Move Project Up";
      moveUpBtn.disabled = appData.indexOf(project) === 0;
      moveUpBtn.onclick = () => {
        const index = appData.indexOf(project);
        if (index > 0) {
          [appData[index], appData[index - 1]] = [appData[index - 1], appData[index]];
          saveData();
          renderProjects();
        }
      };

      const moveDownBtn = document.createElement("button");
      moveDownBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
      moveDownBtn.title = "Move Project Down";
      moveDownBtn.disabled = appData.indexOf(project) === appData.length - 1;
      moveDownBtn.onclick = () => {
        const index = appData.indexOf(project);
        if (index < appData.length - 1) {
          [appData[index], appData[index + 1]] = [appData[index + 1], appData[index]];
          saveData();
          renderProjects();
        }
      };

      const deleteButton = createDeleteButton(() => {
        const index = appData.indexOf(project);
        if (index > -1) {
          appData.splice(index, 1);
          saveData();
          renderProjects();
        }
      });

      // Append buttons in the specified order
      buttonContainer.appendChild(editButton);
      buttonContainer.appendChild(addListButton);
      buttonContainer.appendChild(collapseBtn);
      buttonContainer.appendChild(moveUpBtn);
      buttonContainer.appendChild(moveDownBtn);
      buttonContainer.appendChild(deleteButton);

      header.appendChild(projectName);
      header.appendChild(buttonContainer);
      projectElement.appendChild(header);

      const listsContainer = document.createElement("div");
      listsContainer.classList.add("lists-container");
      if (project.collapsed) listsContainer.style.display = "none";

      project.lists.forEach((list, index) =>
        createList(project, list, listsContainer, index, project.lists.length)
      );

      projectElement.appendChild(listsContainer);

      if (project.milestones && project.milestones.length > 0) {
        const timelineContainer = createTimeline(project);
        projectElement.insertBefore(timelineContainer, listsContainer);
      }

      // Add this line back to append to projectsContainer if no container is provided
      if (!projectElement.parentNode) {
        projectsContainer.appendChild(projectElement);
      }

      return projectElement;
    }

    function createList(project, list, container, index, totalLists) {
      if (!list.id) {
        list.id = Date.now() + Math.random();
      }

      const listDiv = document.createElement("div");
      listDiv.classList.add("list");

      const header = document.createElement("div");
      header.classList.add("list-header");

      const rearrangeButtons = document.createElement("div");
      rearrangeButtons.classList.add("rearrange-buttons");

      const headerContent = document.createElement("div");
      headerContent.classList.add("list-header-content");

      const listNameEl = createEditableElement(
        "div",
        list.name,
        (newName) => {
          list.name = newName;
          saveData();
          if (!newName) {
            project.lists = project.lists.filter((l) => l.id !== list.id);
            saveData();
            renderSingleProject(project);
          }
        }
      );

      const addTodoButton = document.createElement("button");
      addTodoButton.innerHTML = '<i class="fa-regular fa-square-check"></i>';
      addTodoButton.title = "New Todo";
      addTodoButton.addEventListener("click", () => {
        openEditor({
          id: Date.now(),
          type: "todo",
          completed: false,
          isNew: true,
          list: list,
        });
      });

      const addNoteButton = document.createElement("button");
      addNoteButton.innerHTML = '<i class="fa-regular fa-note-sticky"></i>';
      addNoteButton.title = "New Note";
      addNoteButton.addEventListener("click", () => {
        openEditor({
          id: Date.now(),
          type: "note",
          isNew: true,
          list: list,
        });
      });

      const addSubListButton = document.createElement("button");
      addSubListButton.innerHTML = '<i class="fas fa-layer-group"></i>';
      addSubListButton.title = "Add Sub-list";
      addSubListButton.addEventListener("click", () => {
        const newSubList = {
          id: Date.now(),
          name: "",
          items: [],
          isSubList: true,
          parentListId: list.id,
          isNew: true,
        };
        if (!list.subLists) list.subLists = [];
        list.subLists.push(newSubList);
        saveData();
        renderSingleProject(project);
      });

      const deleteListButton = createDeleteButton(() => {
        project.lists = project.lists.filter((l) => l.id !== list.id);
        saveData();
        renderSingleProject(project);
      });
      deleteListButton.title = "Delete List";

      if (index > 0) {
        const movePrevBtn = document.createElement("i");
        movePrevBtn.className = "fas fa-chevron-left";
        movePrevBtn.style.cursor = "pointer";
        movePrevBtn.title = "Move List Left";
        movePrevBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();

          const projectIndex = appData.findIndex(p => p.id === project.id);
          if (projectIndex !== -1) {
            [appData[projectIndex].lists[index - 1], appData[projectIndex].lists[index]] = [
              appData[projectIndex].lists[index],
              appData[projectIndex].lists[index - 1],
            ];
            saveData();
            renderSingleProject(appData[projectIndex]);
          }
        });
        rearrangeButtons.appendChild(movePrevBtn);
      }

      if (index < totalLists - 1) {
        const moveNextBtn = document.createElement("i");
        moveNextBtn.className = "fas fa-chevron-right";
        moveNextBtn.style.cursor = "pointer";
        moveNextBtn.title = "Move List Right";
        moveNextBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();

          const projectIndex = appData.findIndex(p => p.id === project.id);
          if (projectIndex !== -1) {
            [appData[projectIndex].lists[index + 1], appData[projectIndex].lists[index]] = [
              appData[projectIndex].lists[index],
              appData[projectIndex].lists[index + 1],
            ];
            saveData();
            renderSingleProject(appData[projectIndex]);
          }
        });
        rearrangeButtons.appendChild(moveNextBtn);
      }

      header.appendChild(rearrangeButtons);
      headerContent.appendChild(listNameEl);
      header.appendChild(headerContent);

      const buttonContainer = document.createElement("div");
      buttonContainer.style.display = "flex";
      buttonContainer.style.gap = "5px";

      buttonContainer.appendChild(addTodoButton);
      buttonContainer.appendChild(addNoteButton);
      buttonContainer.appendChild(addSubListButton);
      buttonContainer.appendChild(deleteListButton);
      headerContent.appendChild(buttonContainer);

      const listItemsContainer = document.createElement("div");
      listItemsContainer.classList.add("list-items");

      listItemsContainer.addEventListener("dragover", (e) => {
        e.preventDefault();
        const draggingItem = document.querySelector(".dragging");
        if (!draggingItem) return;

        const items = Array.from(listItemsContainer.children);
        const lastItem = items[items.length - 1];

        if (
          !items.length ||
          (lastItem && e.clientY > lastItem.getBoundingClientRect().bottom)
        ) {
          removePlaceholders();
          const placeholder = createPlaceholder();
          listItemsContainer.appendChild(placeholder);
        }
      });

      listItemsContainer.addEventListener("dragleave", () => {
        listItemsContainer.classList.remove("drop-highlight");
      });

      listItemsContainer.addEventListener("drop", (e) => {
        e.preventDefault();
        try {
          const data = JSON.parse(e.dataTransfer.getData("text/plain"));

          if (data.type === "sublist") {
            const { subListId, parentListId, sourceListId } = data;
            const sourceList = appData
              .flatMap((p) => p.lists)
              .find((l) => l.id === sourceListId);

            if (!sourceList) return;
            if (!sourceList.subLists) sourceList.subLists = [];

            const draggedSubList = sourceList.subLists.find(
              (sl) => sl.id === subListId
            );
            if (!draggedSubList) return;

            sourceList.subLists = sourceList.subLists.filter(
              (sl) => sl.id !== subListId
            );

            if (!list.subLists) {
              list.subLists = [];
            }

            const placeholder =
              listItemsContainer.querySelector(".drop-placeholder");
            if (placeholder) {
              const items = Array.from(listItemsContainer.children);
              const placeholderIndex = items.indexOf(placeholder);
              const numItems = list.items.length;
              const subListIndex = Math.max(0, placeholderIndex - numItems);
              list.subLists.splice(subListIndex, 0, draggedSubList);
            } else {
              list.subLists.push(draggedSubList);
            }
            draggedSubList.parentListId = list.id;
          } else {
            const { itemId, listId, isSubListItem, parentListId } = data;

            let sourceList;
            let sourceItems;

            if (isSubListItem) {
              const parentList = appData
                .flatMap((p) => p.lists)
                .find((l) => l.id === parentListId);

              if (parentList && parentList.subLists) {
                sourceList = parentList.subLists.find(
                  (sl) => sl.id === listId
                );
                if (sourceList) {
                  sourceItems = sourceList.items;
                }
              }
            } else {
              sourceList = appData
                .flatMap((p) => p.lists)
                .find((l) => l.id === listId);
              if (sourceList) {
                sourceItems = sourceList.items;
              }
            }

            if (!sourceItems) return;
            const draggedItem = sourceItems.find((i) => i.id === itemId);
            if (!draggedItem) return;

            sourceItems = sourceItems.filter((i) => i.id !== itemId);
            if (isSubListItem) {
              sourceList.items = sourceItems;
            } else {
              sourceList.items = sourceItems;
            }

            const placeholder =
              listItemsContainer.querySelector(".drop-placeholder");
            if (placeholder) {
              const items = Array.from(listItemsContainer.children);
              const placeholderIndex = items.indexOf(placeholder);

              list.items.splice(placeholderIndex, 0, draggedItem);
            } else {
              list.items.push(draggedItem);
            }
          }

          saveData();
          renderSingleProject(project);
        } catch (err) {
          console.error("Error during drag and drop:", err);
        }
      });

      if (!list.items) list.items = [];

      list.items.forEach((item) =>
        createListItem(list, item, listItemsContainer, project)
      );

      if (!list.subLists) {
        list.subLists = [];
      }

      if (list.subLists.length > 0) {
        list.subLists.forEach((subList) => {
          if (!subList) return;
          subList.isSubList = true;
          subList.parentListId = list.id;

          const subListDiv = document.createElement("div");
          subListDiv.classList.add("sub-list");
          subListDiv.setAttribute("draggable", "true");
          subListDiv.dataset.subListId = subList.id;

          const subListHeader = document.createElement("div");
          subListHeader.classList.add("sub-list-header");

          const subListTitle = createEditableElement(
            "div",
            subList.name,
            (newName) => {
              if (newName) {
                subList.name = newName;
                subList.isNew = false;
                saveData();
              } else if (subList.isNew || !subList.name) {
                list.subLists = list.subLists.filter(
                  (sl) => sl.id !== subList.id
                );
                saveData();
                renderSingleProject(project);
              } else {
                subListTitle.innerHTML = formatTextWithLinks(subList.name);
              }
            }
          );
          subListTitle.style.flexGrow = "1";

          if (subList.isNew || !subList.name) {
            setTimeout(() => {
              subListTitle.contentEditable = true;
              subListTitle.focus();
            }, 0);
          }

          const deleteSubListButton = createDeleteButton(() => {
            list.subLists = list.subLists.filter(
              (sl) => sl.id !== subList.id
            );
            saveData();
            renderSingleProject(project);
          });

          subListHeader.appendChild(subListTitle);
          subListHeader.appendChild(deleteSubListButton);
          subListDiv.appendChild(subListHeader);

          const subListItems = document.createElement("div");
          subListItems.classList.add("sub-list-items");

          if (!subList.items) {
            subList.items = [];
          }

          subList.items.forEach((item) => {
            if (!item) return;
            item.parentListId = list.id;
            createListItem(subList, item, subListItems, project);
          });

          subListItems.addEventListener("dragover", (e) => {
            e.preventDefault();
            const draggingItem = document.querySelector(".dragging");
            if (!draggingItem) return;

            removePlaceholders();
            const placeholder = createPlaceholder();
            subListItems.appendChild(placeholder);
          });

          subListItems.addEventListener("drop", (e) => {
            e.preventDefault();
            try {
              const data = JSON.parse(e.dataTransfer.getData("text/plain"));

              if (data.type === "sublist") {
                const { subListId, parentListId, sourceListId } = data;
                const sourceList = appData
                  .flatMap((p) => p.lists)
                  .find((l) => l.id === sourceListId);
                const draggedSubList = sourceList.subLists.find(
                  (sl) => sl.id === subListId
                );

                if (!draggedSubList || draggedSubList.id === subList.id)
                  return;

                sourceList.subLists = sourceList.subLists.filter(
                  (sl) => sl.id !== subListId
                );

                const placeholder =
                  subListItems.querySelector(".drop-placeholder");
                if (placeholder) {
                  const items = Array.from(subListItems.children);
                  const placeholderIndex = items.indexOf(placeholder);

                  subList.items.splice(placeholderIndex, 0, draggedSubList);
                } else {
                  subList.items.push(draggedSubList);
                }
                draggedSubList.parentListId = list.id;
              } else {
                const { itemId, listId, isSubListItem, parentListId } = data;

                let sourceList;
                let sourceItems;

                if (isSubListItem) {
                  const parentList = appData
                    .flatMap((p) => p.lists)
                    .find((l) => l.id === parentListId);

                  if (parentList && parentList.subLists) {
                    sourceList = parentList.subLists.find(
                      (sl) => sl.id === listId
                    );
                    if (sourceList) {
                      sourceItems = sourceList.items;
                    }
                  }
                } else {
                  sourceList = appData
                    .flatMap((p) => p.lists)
                    .find((l) => l.id === listId);
                  if (sourceList) {
                    sourceItems = sourceList.items;
                  }
                }

                if (!sourceItems) return;
                const draggedItem = sourceItems.find((i) => i.id === itemId);
                if (!draggedItem) return;

                sourceItems = sourceItems.filter((i) => i.id !== itemId);
                if (isSubListItem) {
                  sourceList.items = sourceItems;
                } else {
                  sourceList.items = sourceItems;
                }

                const placeholder =
                  subListItems.querySelector(".drop-placeholder");
                if (placeholder) {
                  const items = Array.from(subListItems.children);
                  const placeholderIndex = items.indexOf(placeholder);

                  subList.items.splice(placeholderIndex, 0, draggedItem);
                } else {
                  subList.items.push(draggedItem);
                }
              }

              saveData();
              renderSingleProject(project);
            } catch (err) {
              console.error("Error during drag and drop:", err);
            }
          });

          subListDiv.addEventListener("dragstart", (e) => {
            e.stopPropagation();
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData(
              "text/plain",
              JSON.stringify({
                subListId: subList.id,
                parentListId: list.id,
                type: "sublist",
                sourceListId: list.id,
              })
            );
            subListDiv.classList.add("dragging");
            removePlaceholders();
          });

          subListDiv.addEventListener("dragend", () => {
            subListDiv.classList.remove("dragging");
            removePlaceholders();
          });

          subListDiv.appendChild(subListItems);
          listItemsContainer.appendChild(subListDiv);
        });
      }

      listDiv.appendChild(header);
      listDiv.appendChild(listItemsContainer);
      container.appendChild(listDiv);
    }

    function createListItem(list, item, container, project) {
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("list-item");
      itemDiv.setAttribute("draggable", "true");

      const itemContent = document.createElement("div");
      if (item.type === "todo") {
        itemDiv.classList.add("todo-item");
        itemContent.classList.add("item-name");
        if (item.completed) {
          itemContent.classList.add("strikethrough");
        }
      }

      if (item.backgroundColor) {
        itemDiv.style.backgroundColor = item.backgroundColor;
      }

      const hoverMenu = document.createElement("div");
      hoverMenu.classList.add("item-hover-menu");

      const editorBtn = document.createElement("button");
      editorBtn.innerHTML = '<i class="fas fa-pen-to-square"></i>';
      editorBtn.title = "Open Editor";
      editorBtn.addEventListener("click", () => openEditor(item));

      const toggleTypeBtn = document.createElement("button");
      toggleTypeBtn.innerHTML = '<i class="fa-solid fa-shuffle"></i>';
      toggleTypeBtn.title =
        item.type === "todo" ? "Convert to Note" : "Convert to Todo";
      toggleTypeBtn.addEventListener("click", () => {
        if (item.type === "todo") {
          item.type = "note";
          delete item.completed;
        } else {
          item.type = "todo";
          item.completed = false;
        }
        saveData();
        renderSingleProject(project);
      });

      const colorInput = document.createElement("input");
      colorInput.type = "text";
      colorInput.setAttribute("data-coloris", "");
      colorInput.style.display = "none";

      const colorPickerBtn = document.createElement("button");
      colorPickerBtn.innerHTML = '<i class="fas fa-fill-drip"></i>';
      colorPickerBtn.title = "Change Color";
      colorPickerBtn.addEventListener("click", () => {
        colorInput.click();
        Coloris.open(colorInput);
      });

      colorInput.addEventListener("change", (event) => {
        const color = event.target.value;
        item.backgroundColor = color;
        itemDiv.style.backgroundColor = color;
        saveData();
      });

      if (item.type === "todo" && item.dueDate) {
        const now = new Date();
        const dueDate = new Date(item.dueDate);
        const diffTime = dueDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffTime < 0) {
          itemDiv.classList.add("overdue");
        } else if (diffDays <= 2) {
          itemDiv.classList.add("due-soon");
        }

        const dueInfo = document.createElement("span");
        dueInfo.classList.add("due-date-info");
        dueInfo.textContent = formatDueDate(item.dueDate);
        itemContent.appendChild(dueInfo);
      }

      if (item.type === "todo") {
        const timerControls = document.createElement("div");
        timerControls.classList.add("time-tracker");

        const playPauseBtn = document.createElement("button");
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        playPauseBtn.title = "Start Timer";

        const timerDisplay = document.createElement("span");
        timerDisplay.classList.add("elapsed-time");
        timerDisplay.textContent = formatTime(item.elapsedTime || 0);

        playPauseBtn.addEventListener("click", () => {
          if (activeTimers.has(item.id)) {
            stopTimer(item);
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.title = "Start Timer";
          } else {
            startTimer(item, timerDisplay);
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.title = "Pause Timer";
          }
        });

        timerControls.appendChild(playPauseBtn);
        timerControls.appendChild(timerDisplay);
        hoverMenu.appendChild(timerControls);
      }

      const deleteButton = createDeleteButton(() => {
        list.items = list.items.filter((i) => i.id !== item.id);
        saveData();
        renderSingleProject(project);
      });

      hoverMenu.appendChild(editorBtn);
      hoverMenu.appendChild(toggleTypeBtn);
      hoverMenu.appendChild(colorPickerBtn);
      hoverMenu.appendChild(colorInput);
      hoverMenu.appendChild(deleteButton);

      itemDiv.appendChild(hoverMenu);

      if (item.type === "todo") {
        itemDiv.classList.add("todo-item");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = item.completed;
        checkbox.classList.add("todo-checkbox");
        checkbox.addEventListener("change", () => {
          item.completed = checkbox.checked;
          itemContent.classList.toggle("strikethrough", item.completed);
          if (item.completed) {
            stopTimer(item);
            addToHistory(item);
            item.completedAt = new Date().toISOString();
          } else {
            delete item.completedAt;
          }
          saveData();
        });

        itemDiv.appendChild(checkbox);

        itemContent.classList.add("item-name");
        if (item.completed) {
          itemContent.classList.add("strikethrough");
        }
      }

      itemContent.innerHTML = formatTextWithLinks(
        stripHtml(item.content || item.name || "").substring(0, 100) + 
        (item.content && item.content.length > 100 ? "..." : "")
      );
      
      itemContent.addEventListener("click", () => openEditor(item));
      itemContent.style.cursor = "pointer";

      itemDiv.appendChild(itemContent);
      container.appendChild(itemDiv);

      itemDiv.addEventListener("dragstart", (e) => {
        e.stopPropagation();

        e.dataTransfer.effectAllowed = "move";

        const isSubListItem = list.isSubList || false;
        const parentListId = list.parentListId || list.id;

        e.dataTransfer.setData(
          "text/plain",
          JSON.stringify({
            itemId: item.id,
            listId: list.id,
            isSubListItem: isSubListItem,
            parentListId: parentListId,
            type: "item",
          })
        );
        itemDiv.classList.add("dragging");
        removePlaceholders();
      });

      itemDiv.addEventListener("dragend", (e) => {
        e.stopPropagation();

        itemDiv.classList.remove("dragging");

        removePlaceholders();
        document.querySelectorAll(".shift-up, .shift-down").forEach((el) => {
          el.classList.remove("shift-up", "shift-down");
        });
      });

      itemDiv.addEventListener("dragover", (e) => {
        e.stopPropagation();
        e.preventDefault();
        const draggingItem = document.querySelector(".dragging");
        if (!draggingItem || draggingItem === itemDiv) return;

        removePlaceholders();

        const rect = itemDiv.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;

        if (e.clientY < midY) {
          const placeholder = createPlaceholder();
          itemDiv.before(placeholder);
        } else {
          const placeholder = createPlaceholder();
          itemDiv.after(placeholder);
        }
      });

      itemDiv.addEventListener("dragleave", (e) => {
        e.stopPropagation();

        itemDiv.classList.remove(
          "drop-highlight-top",
          "drop-highlight-bottom"
        );
      });

      itemDiv.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();

        try {
          const { itemId, listId, isSubListItem, parentListId } = JSON.parse(
            e.dataTransfer.getData("text/plain")
          );

          let sourceList;
          let sourceItems;

          if (isSubListItem) {
            const parentList = appData
              .flatMap((p) => p.lists)
              .find((l) => l.id === parentListId);

            if (parentList && parentList.subLists) {
              sourceList = parentList.subLists.find((sl) => sl.id === listId);
              if (sourceList) {
                sourceItems = sourceList.items;
              }
            }
          } else {
            sourceList = appData
              .flatMap((p) => p.lists)
              .find((l) => l.id === listId);
            if (sourceList) {
              sourceItems = sourceList.items;
            }
          }

          if (!sourceItems) return;
          const draggedItem = sourceItems.find((i) => i.id === itemId);
          if (!draggedItem) return;

          sourceItems = sourceItems.filter((i) => i.id !== itemId);
          if (isSubListItem) {
            sourceList.items = sourceItems;
          } else {
            sourceList.items = sourceItems;
          }

          const placeholder = container.querySelector(".drop-placeholder");
          if (placeholder) {
            const items = Array.from(container.children);
            const placeholderIndex = items.indexOf(placeholder);

            list.items.splice(placeholderIndex, 0, draggedItem);
          } else {
            list.items.push(draggedItem);
          }

          saveData();
          renderSingleProject(project);
        } catch (err) {
          console.error("Error during drag and drop:", err);
        }
      });
    }

    function formatDueDate(dueDate) {
      const now = new Date();
      const due = new Date(dueDate);
      const diffTime = due - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffTime < 0) {
        return "Overdue";
      } else if (diffDays === 0) {
        return "Due today";
      } else if (diffDays === 1) {
        return "Due tomorrow";
      } else {
        return `Due in ${diffDays} days`;
      }
    }

    function createPlaceholder() {
      const placeholder = document.createElement("div");
      placeholder.classList.add("drop-placeholder");
      return placeholder;
    }

    function removePlaceholders() {
      document
        .querySelectorAll(".drop-placeholder")
        .forEach((el) => el.remove());
    }

    function renderProjects() {
      projectsContainer.innerHTML = "";
      appData.forEach(project => {
        createProject(project);
      });

      Coloris({
        theme: "default",
        themeMode: currentTheme,
        formatToggle: false,
        clearButton: true,
        alpha: false,
        wrap: true,
        closeButton: true,
        swatches: [
          "#264653",
          "#2a9d8f",
          "#e9c46a",
          "#f4a261",
          "#e76f51",
          "#ef476f",
          "#ffd166",
          "#06d6a0",
          "#118ab2",
          "#073b4c",
        ],
      });
    }

    addProjectBtn.addEventListener("click", () => {
      const newProject = { id: Date.now(), name: "", lists: [] };
      appData.unshift(newProject);
      saveData();
      renderProjects();
    });

    importDataBtn.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";

      input.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);
              if (Array.isArray(importedData)) {
                appData = importedData;
                saveData();
                renderProjects();
                
                // Visual confirmation
                const originalText = importDataBtn.textContent;
                const originalBg = importDataBtn.style.backgroundColor;
                importDataBtn.textContent = "✓ Imported";
                importDataBtn.style.backgroundColor = "#28a745";
                
                // Reset after 2 seconds
                setTimeout(() => {
                  importDataBtn.textContent = originalText;
                  importDataBtn.style.backgroundColor = originalBg;
                }, 2000);
              } else {
                // Error indication
                importDataBtn.textContent = "⚠ Invalid Format";
                importDataBtn.style.backgroundColor = "#dc3545";
                setTimeout(() => {
                  importDataBtn.textContent = "Import";
                  importDataBtn.style.backgroundColor = "";
                }, 2000);
              }
            } catch (error) {
              // Error indication
              importDataBtn.textContent = "⚠ Invalid File";
              importDataBtn.style.backgroundColor = "#dc3545";
              setTimeout(() => {
                importDataBtn.textContent = "Import";
                importDataBtn.style.backgroundColor = "";
              }, 2000);
            }
          };
          reader.readAsText(file);
        }
      });

      input.click();
    });

    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      currentTheme = theme;
      themeToggleBtn.innerHTML =
        theme === "dark"
          ? '<i class="fas fa-sun"></i>'
          : '<i class="fas fa-moon"></i>';
    }

    setTheme(currentTheme);

    themeToggleBtn.addEventListener("click", () => {
      const newTheme = currentTheme === "light" ? "dark" : "light";
      setTheme(newTheme);
    });

    document.addEventListener("DOMContentLoaded", () => {
      Coloris({
        theme: "default",
        themeMode: currentTheme,
        formatToggle: false,
        clearButton: true,
        alpha: false,
        wrap: true,
        closeButton: true,
        swatches: [
          "#264653",
          "#2a9d8f",
          "#e9c46a",
          "#f4a261",
          "#e76f51",
          "#ef476f",
          "#ffd166",
          "#06d6a0",
          "#118ab2",
          "#073b4c",
        ],
      });

      renderProjects();
    });

    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    function openEditor(item) {
      const popup = document.querySelector(".editor-popup");
      const overlay = document.querySelector(".editor-overlay");
      const closeBtn = popup.querySelector(".close-btn");
      const dueDateContainer = popup.querySelector(".due-date-container");
      const dueDateInput = popup.querySelector("#dueDateInput");
      const clearDueDate = popup.querySelector("#clearDueDate");
      const dueDateInfo = popup.querySelector(".due-date-info");
      const headerTitle = popup.querySelector(".editor-header h3");

      $('#summernote').empty();
      if ($('#summernote').data('summernote')) {
        $('#summernote').summernote('destroy');
      }

      dueDateContainer.style.display = item.type === "todo" ? "flex" : "none";
      headerTitle.textContent = item.type === "todo" ? "Edit Todo" : "Edit Note";

      if (item.type === "todo" && item.dueDate) {
        dueDateInput.value = item.dueDate.slice(0, 10);
        updateDueDateInfo(item.dueDate);
      } else {
        dueDateInput.value = "";
        dueDateInfo.textContent = "";
      }

      $('#summernote').summernote({
        height: "100%",
        minHeight: null,
        maxHeight: null,
        placeholder: "Start typing...",
        focus: true,
        callbacks: {
          onInit: function() {
            if (!item.isNew) {
              $('#summernote').summernote('code', item.content || item.name || '');
            }
            
            setTimeout(() => {
              $('#summernote').summernote('focus');
              $('.note-editable').focus();
              const range = document.createRange();
              const sel = window.getSelection();
              const editableDiv = $('.note-editable')[0];
              range.selectNodeContents(editableDiv);
              range.collapse(false);
              sel.removeAllRanges();
              sel.addRange(range);
              $('.note-editor').css('display', 'flex');
              $('.note-editing-area').css('display', 'flex');
              $('#summernote').css('display', 'flex');
            }, 100);
          },
          onChange: function(contents) {
            if (!item.isNew) {
              item.content = contents;
              saveData();
            }
          }
        },
        spellCheck: true,
        disableGrammar: false,
        styleTags: ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
        prettifyHtml: false,
        emptyPara: ''
      });

      popup.style.display = "flex";
      overlay.style.display = "block";

      dueDateInput.addEventListener("change", function () {
        if (this.value) {
          const date = new Date(this.value);
          date.setHours(0, 0, 0, 0);
          item.dueDate = date.toISOString();
          updateDueDateInfo(item.dueDate);
          
          const project = appData.find(p => 
            p.lists.some(l => 
              l.items.some(i => i.id === item.id) || 
              (l.subLists && l.subLists.some(sl => sl.items.some(i => i.id === item.id)))
            )
          );
          
          if (project) {
            saveData();
            renderSingleProject(project);
          }
        }
        saveData();
      });

      clearDueDate.addEventListener("click", function () {
        dueDateInput.value = "";
        delete item.dueDate;
        dueDateInfo.textContent = "";
        
        const project = appData.find(p => 
          p.lists.some(l => 
            l.items.some(i => i.id === item.id) || 
            (l.subLists && l.subLists.some(sl => sl.items.some(i => i.id === item.id)))
          )
        );
        
        if (project) {
          saveData();
          renderSingleProject(project);
        }
      });

      const closeEditor = () => {
        const content = $('#summernote').summernote('code');
        const strippedContent = stripHtml(content).trim();

        if (item.isNew && strippedContent !== "") {
          const newItem = {
            id: item.id,
            name: strippedContent.substring(0, 50),
            type: item.type,
            content: content,
            completed: item.type === "todo" ? false : undefined,
          };

          if (item.list) {
            item.list.items.push(newItem);
            saveData();
            const project = appData.find(p =>
              p.lists.some(l => l.id === item.list.id)
            );
            if (project) {
              renderSingleProject(project);
            }
          }
        }

        $('#summernote').empty();
        $('#summernote').summernote('destroy');
        popup.style.display = "none";
        overlay.style.display = "none";
      };

      closeBtn.onclick = closeEditor;
      overlay.onclick = closeEditor;
    }

    function updateDueDateInfo(dueDate) {
      const dueDateInfo = document.querySelector(".due-date-info");
      const now = new Date();
      const due = new Date(dueDate);
      const diffTime = due - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffTime < 0) {
        dueDateInfo.textContent = "Overdue";
        dueDateInfo.style.color = "#ff4444";
      } else if (diffDays === 0) {
        dueDateInfo.textContent = "Due today";
        dueDateInfo.style.color = "#ffd700";
      } else if (diffDays === 1) {
        dueDateInfo.textContent = "Due tomorrow";
        dueDateInfo.style.color = "#ffd700";
      } else {
        dueDateInfo.textContent = `Due in ${diffDays} days`;
        dueDateInfo.style.color = "";
      }
    }

    function formatTextWithLinks(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, (url) => {
        const safeUrl = url
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
        return `<a href="${safeUrl}" class="item-link" target="_blank">${safeUrl}</a>`;
      });
    }

    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hrs.toString().padStart(2, "0")}:${mins
        .toString()
        .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
    }

    function startTimer(item, timerDisplay) {
      if (activeTimers.has(item.id)) return;

      if (!item.startTime) {
        item.startTime = new Date().toISOString();
      }

      const startTime = Date.now() - (item.elapsedTime || 0) * 1000;
      const timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        item.elapsedTime = elapsed;
        timerDisplay.textContent = formatTime(elapsed);
        saveData();
      }, 1000);

      activeTimers.set(item.id, timer);
    }

    function stopTimer(item) {
      const timer = activeTimers.get(item.id);
      if (timer) {
        clearInterval(timer);
        activeTimers.delete(item.id);
      }
    }

    function addToHistory(item) {
      taskHistory.push({
        task: item.content || item.name,
        timeTaken: item.elapsedTime || 0,
        startedAt: item.startTime || new Date().toISOString(),
        completedAt: new Date().toISOString(),
      });
      localStorage.setItem("taskHistory", JSON.stringify(taskHistory));
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString("en-AU", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
      });
    }

    function renderHistory(tbody, filter = "") {
      const filteredHistory = taskHistory.filter((entry) =>
        stripHtml(entry.task).toLowerCase().includes(filter.toLowerCase())
      );

      if (filteredHistory.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; font-size: 1.1em; color: #666;">
              ${filter ? "No tasks found matching your search. Try something else?" : "No completed tasks yet. Time to get productive! 🚀"}
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = filteredHistory
          .map((entry, index) => {
            const plainText = stripHtml(entry.task);
            
            let taskDisplay;
            if (plainText.length > 100) {
              taskDisplay = `
                <span class="truncated-text" data-index="${index}">${plainText.substring(0, 100)}...</span>
                <span class="full-text" data-index="${index}" style="display: none;">${plainText}</span>
                <button class="read-more-btn" data-index="${index}">Read More</button>
              `;
            } else {
              taskDisplay = plainText;
            }

            return `
              <tr data-index="${index}">
                <td>${taskDisplay}</td>
                <td>${formatDate(entry.startedAt)}</td>
                <td>${formatDate(entry.completedAt)}</td>
                <td>${formatTime(entry.timeTaken)}</td>
                <td class="action-column">
                  <button class="delete-history-btn" title="Delete Entry">
                    <i class="fas fa-times"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join("");

        tbody.querySelectorAll(".read-more-btn").forEach((btn) => {
          btn.addEventListener("click", function() {
            const index = this.getAttribute('data-index');
            const truncatedText = tbody.querySelector(`.truncated-text[data-index="${index}"]`);
            const fullText = tbody.querySelector(`.full-text[data-index="${index}"]`);

            if (truncatedText.style.display !== "none") {
              truncatedText.style.display = "none";
              fullText.style.display = "inline";
              this.textContent = "Show Less";
            } else {
              truncatedText.style.display = "inline";
              fullText.style.display = "none";
              this.textContent = "Read More";
            }
          });
        });

        tbody.querySelectorAll(".delete-history-btn").forEach((btn) => {
          btn.addEventListener("click", function() {
            const row = this.closest("tr");
            const index = parseInt(row.dataset.index);
            taskHistory.splice(index, 1);
            localStorage.setItem("taskHistory", JSON.stringify(taskHistory));
            renderHistory(tbody, document.querySelector(".history-search").value);
          });
        });
      }
    }

    function clearHistory() {
      if (
        confirm(
          "Are you sure you want to clear all task history? This cannot be undone."
        )
      ) {
        taskHistory = [];
        localStorage.setItem("taskHistory", JSON.stringify(taskHistory));
        const tbody = document.querySelector(".history-modal tbody");
        renderHistory(tbody);
      }
    }

    function showHistory() {
      const modal = document.querySelector(".history-modal");
      const overlay = document.querySelector(".history-overlay");
      const searchInput = modal.querySelector(".history-search");
      const tbody = modal.querySelector("tbody");
      const cleanupBtn = modal.querySelector(".cleanup-btn");

      searchInput.value = "";
      searchInput.addEventListener("input", (e) =>
        renderHistory(tbody, e.target.value)
      );
      cleanupBtn.addEventListener("click", clearHistory);
      renderHistory(tbody);

      modal.style.display = "block";
      overlay.style.display = "block";

      const closeModal = () => {
        modal.style.display = "none";
        overlay.style.display = "none";
      };

      modal.querySelector(".close-btn").onclick = closeModal;
      overlay.onclick = closeModal;
    }

    historyBtn.addEventListener("click", showHistory);

    function showProjectForm(projectToEdit = null) {
      const form = document.querySelector(".project-form");
      const overlay = document.querySelector(".form-overlay");
      const milestoneEntries = document.getElementById("milestoneEntries");
      const projectNameInput = document.getElementById("projectName");
      const submitBtn = document.querySelector(".submit-btn");

      form.querySelector("h2").textContent = projectToEdit
        ? "Edit Project"
        : "New Project";
      submitBtn.title = projectToEdit ? "Save Changes" : "Create Project";

      projectNameInput.value = "";
      milestoneEntries.innerHTML = "";

      if (projectToEdit) {
        projectNameInput.value = projectToEdit.name;

        if (projectToEdit.milestones) {
          projectToEdit.milestones.forEach((milestone) => {
            const entry = document.createElement("div");
            entry.classList.add("milestone-entry");

            entry.innerHTML = `
              <input type="text" class="milestone-name" placeholder="Milestone name" value="${milestone.name}">
              <input type="date" class="milestone-date" value="${milestone.date}">
              <span class="remove-milestone" title="Remove Milestone">×</span>
            `;

            entry
              .querySelector(".remove-milestone")
              .addEventListener("click", () => {
                entry.remove();
              });

            milestoneEntries.appendChild(entry);
          });
        }
      }

      if (milestoneEntries.children.length === 0) {
        addMilestoneEntry();
      }

      form.style.display = "block";
      overlay.style.display = "block";

      submitBtn.onclick = () => {
        const projectName = projectNameInput.value.trim();
        if (!projectName) return;

        const milestones = Array.from(
          document.querySelectorAll(".milestone-entry")
        )
          .map((entry) => ({
            name: entry.querySelector(".milestone-name").value.trim(),
            date: entry.querySelector(".milestone-date").value,
          }))
          .filter((m) => m.name && m.date);

        if (projectToEdit) {
          projectToEdit.name = projectName;
          projectToEdit.milestones =
            milestones.length > 0 ? milestones : undefined;
        } else {
          const newProject = {
            id: Date.now(),
            name: projectName,
            lists: [],
            milestones: milestones.length > 0 ? milestones : undefined,
          };
          appData.unshift(newProject);
        }

        saveData();
        renderProjects();

        form.style.display = "none";
        overlay.style.display = "none";
      };
    }

    function addMilestoneEntry() {
      const container = document.getElementById("milestoneEntries");
      const entry = document.createElement("div");
      entry.classList.add("milestone-entry");

      entry.innerHTML = `
        <input type="text" class="milestone-name" placeholder="Milestone name">
        <input type="date" class="milestone-date">
        <span class="remove-milestone" title="Remove Milestone">×</span>
      `;

      entry
        .querySelector(".remove-milestone")
        .addEventListener("click", () => {
          entry.remove();
        });

      container.appendChild(entry);
    }

    function createTimeline(project) {
      if (!project.milestones || project.milestones.length === 0) return;

      const timelineContainer = document.createElement("div");
      timelineContainer.classList.add("timeline-container");

      const timelineDiv = document.createElement("div");
      timelineDiv.classList.add("timeline");
      timelineDiv.id = `timeline-${project.id}`;

      timelineContainer.appendChild(timelineDiv);

      timelineContainer.addEventListener("dblclick", () => {
        showProjectForm(project);
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.classList.add("timeline-delete-btn");
      deleteBtn.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
      deleteBtn.title = "Delete Timeline";

      let confirmTimeout;
      let isConfirming = false;

      deleteBtn.addEventListener("click", () => {
        if (isConfirming) {
          clearTimeout(confirmTimeout);
          delete project.milestones;
          saveData();
          renderSingleProject(project);
        } else {
          isConfirming = true;
          deleteBtn.innerHTML = "Sure?";
          deleteBtn.title = "Click again to confirm deletion";
          deleteBtn.classList.add("delete-confirm");

          confirmTimeout = setTimeout(() => {
            isConfirming = false;
            deleteBtn.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
            deleteBtn.title = "Delete Timeline";
            deleteBtn.classList.remove("delete-confirm");
          }, 5000);
        }
      });

      timelineContainer.appendChild(deleteBtn);

      const formatDate = (date) => {
        return new Date(date).toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      };

      const dates = project.milestones.map((m) => new Date(m.date));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      minDate.setDate(minDate.getDate() - 14);
      maxDate.setDate(maxDate.getDate() + 14);

      const items = new DataSet(
        project.milestones.map((milestone, index) => ({
          id: index,
          content: milestone.name,
          start: milestone.date,
          title: `${milestone.name}<br>${formatDate(milestone.date)}`,
        }))
      );

      const options = {
        height: "100px",
        min: minDate,
        max: maxDate,
        zoomable: false,
        margin: { item: 10 },
        orientation: { axis: "top" },
        selectable: false,
        showTooltips: true,
        stack: false,
        horizontalScroll: false,
        timeAxis: {
          scale: "week",
          step: 1,
        },
        align: "center",
        type: "point",
        template: function (item) {
          return `<div class="vis-item-content">${item.content}</div>`;
        },
        format: {
          minorLabels: {
            week: "",
            month: "MMM",
          },
          majorLabels: {
            month: "YYYY",
          },
        },
        snap: null,
        verticalScroll: false,
        showCurrentTime: true,
        showMajorLabels: true,
        showMinorLabels: true,
        width: "100%",
        autoResize: true,
        start: minDate,
        end: maxDate,
      };

      const timeline = new Timeline(timelineDiv, items, options);
      timeline.fit();

      return timelineContainer;
    }

    addProjectBtn.removeEventListener("click", addProjectBtn.onclick);
    addProjectBtn.addEventListener("click", () => showProjectForm(null));

    document
      .querySelector(".add-milestone-btn")
      .addEventListener("click", addMilestoneEntry);

    document.querySelector(".cancel-btn").addEventListener("click", () => {
      document.querySelector(".project-form").style.display = "none";
      document.querySelector(".form-overlay").style.display = "none";
    });

    function isFileSystemAccessSupported() {
      return (
        window.showDirectoryPicker &&
        typeof window.showDirectoryPicker === "function"
      );
    }

    async function getBackupDirectory() {
      const serializedHandle = localStorage.getItem(AUTO_BACKUP_KEY);
      if (!serializedHandle) return null;

      try {
        const savedData = JSON.parse(serializedHandle);

        if (window.currentDirHandle) {
          return window.currentDirHandle;
        }

        try {
          const dirHandle = await window.showDirectoryPicker({
            mode: "readwrite",
            startIn: savedData.name,
          });

          const newSerializedHandle = await serializeDirectoryHandle(
            dirHandle
          );
          localStorage.setItem(AUTO_BACKUP_KEY, newSerializedHandle);
          return dirHandle;
        } catch (err) {
          try {
            const dirHandle = await window.showDirectoryPicker({
              mode: "readwrite",
            });

            const newSerializedHandle = await serializeDirectoryHandle(
              dirHandle
            );
            localStorage.setItem(AUTO_BACKUP_KEY, newSerializedHandle);
            return dirHandle;
          } catch (err2) {
            if (err2.name === "AbortError") {
              console.log("User cancelled directory selection");
              return null;
            }
            throw err2;
          }
        }
      } catch (err) {
        console.error("Error getting backup directory:", err);
        return null;
      }
    }

    async function setupAutoBackup() {
      if (!isFileSystemAccessSupported()) {
        alert(
          "Your browser does not support automatic backups. Please use Chrome, Edge, or Opera."
        );
        return;
      }

      try {
        console.log("Attempting to show directory picker...");

        const dirHandle = await window
          .showDirectoryPicker({
            mode: "readwrite",
          })
          .catch((err) => {
            console.error("Directory picker error:", err);
            throw err;
          });

        window.currentDirHandle = dirHandle;

        try {
          const permission = await dirHandle.requestPermission({
            mode: "readwrite",
          });
          console.log("Initial permission status:", permission);

          if (permission !== "granted") {
            throw new Error("Permission not granted for directory access");
          }
        } catch (permErr) {
          console.error("Permission error:", permErr);
          throw permErr;
        }

        try {
          const serializedHandle = await serializeDirectoryHandle(dirHandle);
          console.log("Handle serialized successfully");
          localStorage.setItem(AUTO_BACKUP_KEY, serializedHandle);
          console.log("Handle stored in localStorage");
        } catch (serializeErr) {
          console.error("Serialization error:", serializeErr);
          throw serializeErr;
        }

        console.log("Attempting initial backup...");
        const backupSuccess = await performAutoBackup(true);
        console.log("Initial backup result:", backupSuccess);

        if (backupSuccess) {
          const formattedDate = new Date().toLocaleString("en-AU", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          });
          localStorage.setItem(LAST_BACKUP_KEY, formattedDate);
          alert("Export completed successfully!");
          autoBackupInterval = setInterval(
            performAutoBackup,
            BACKUP_INTERVAL
          );
          console.log("Backup interval set");
        } else {
          throw new Error(
            "Initial backup failed - no error thrown but backup returned false"
          );
        }

        delete window.currentDirHandle;
      } catch (err) {
        delete window.currentDirHandle;
      }
    }

    async function serializeDirectoryHandle(dirHandle) {
      const permission = await dirHandle.requestPermission({
        mode: "readwrite",
      });
      if (permission !== "granted") {
        throw new Error("Permission not granted for directory access");
      }

      return JSON.stringify({
        kind: dirHandle.kind,
        name: dirHandle.name,

        permissionToken: Date.now(),
      });
    }

    async function performAutoBackup(isUserInitiated = false) {
      console.log("Starting backup process...");

      const existingConfig = localStorage.getItem(AUTO_BACKUP_KEY);
      const existingTimestamp = localStorage.getItem(LAST_BACKUP_KEY);

      const dirHandle = isUserInitiated
        ? await getBackupDirectory()
        : await getBackupDirectoryWithoutPicker();

      if (!dirHandle) {
        console.log("No directory handle available - needs user interaction");
        scheduleBackupReminder();
        if (existingConfig)
          localStorage.setItem(AUTO_BACKUP_KEY, existingConfig);
        if (existingTimestamp)
          localStorage.setItem(LAST_BACKUP_KEY, existingTimestamp);
        return false;
      }

      try {
        console.log("Verifying write permission...");
        const permission = await dirHandle.queryPermission({
          mode: "readwrite",
        });
        console.log("Permission status:", permission);

        if (permission !== "granted") {
          const newPermission = await dirHandle.requestPermission({
            mode: "readwrite",
          });
          if (newPermission !== "granted") {
            console.log("Permission not granted after request");
            if (existingConfig)
              localStorage.setItem(AUTO_BACKUP_KEY, existingConfig);
            if (existingTimestamp)
              localStorage.setItem(LAST_BACKUP_KEY, existingTimestamp);
            return false;
          }
        }

        const now = new Date();
        const timestamp =
          now.getFullYear() +
          String(now.getMonth() + 1).padStart(2, "0") +
          String(now.getDate()).padStart(2, "0") +
          "T" +
          String(now.getHours()).padStart(2, "0") +
          String(now.getMinutes()).padStart(2, "0") +
          String(now.getSeconds()).padStart(2, "0");

        const filename = `kanban-backup-${timestamp}.json`;
        console.log("Creating backup file:", filename);

        const fileHandle = await dirHandle.getFileHandle(filename, {
          create: true,
        });
        const writable = await fileHandle.createWritable();

        const data = JSON.stringify(appData, null, 2);
        await writable.write(data);
        await writable.close();

        console.log("Backup completed successfully:", filename);

        const formattedDate = now.toLocaleString("en-AU", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false,
        });

        localStorage.setItem(LAST_BACKUP_KEY, formattedDate);

        const autoBackupBtn = document.getElementById("autoBackupBtn");
        if (autoBackupBtn) {
          autoBackupBtn.classList.add("backup-nudge");
          autoBackupBtn.title = "⚠️ Backup needed - Click to perform backup";
          autoBackupBtn.innerHTML = '⚠️ <i class="fa-solid fa-file-export"></i>';
        }

        setTimeout(nudgeBackup, 60 * 60 * 1000);

        return true;
      } catch (err) {
        console.error("Error during backup:", err);
        nudgeBackup();
        if (existingConfig)
          localStorage.setItem(AUTO_BACKUP_KEY, existingConfig);
        if (existingTimestamp)
          localStorage.setItem(LAST_BACKUP_KEY, existingTimestamp);
        return false;
      }
    }

    async function getBackupDirectoryWithoutPicker() {
      const serializedHandle = localStorage.getItem(AUTO_BACKUP_KEY);
      if (!serializedHandle) return null;

      try {
        const savedData = JSON.parse(serializedHandle);

        if (window.currentDirHandle) {
          return window.currentDirHandle;
        }

        return null;
      } catch (err) {
        console.error("Error parsing backup directory data:", err);
        return null;
      }
    }

    function scheduleBackupReminder() {
      if (!window.backupReminderScheduled) {
        window.backupReminderScheduled = true;

        const autoBackupBtn = document.getElementById("autoBackupBtn");
        if (autoBackupBtn) {
          autoBackupBtn.classList.add("backup-nudge");
          autoBackupBtn.title = "⚠️ Backup needed - Click to perform backup";
          autoBackupBtn.innerHTML = "⚠️ Backup Needed";
        }
      }
    }

    let autoBackupInterval;

    function updateTopMenu() {
      const autoBackupBtn = document.getElementById("autoBackupBtn");
      if (autoBackupBtn && isFileSystemAccessSupported()) {
        autoBackupBtn.title = localStorage.getItem(AUTO_BACKUP_KEY)
          ? "Change Auto-backup Folder"
          : "Setup Auto-backup";
        autoBackupBtn.addEventListener("click", setupAutoBackup);
      }
    }

    async function checkAndPerformBackup() {
      const lastBackupStr = localStorage.getItem(LAST_BACKUP_KEY);
      const now = new Date();

      if (!lastBackupStr) {
        console.log("No previous backup found, performing initial backup...");
        const success = await performAutoBackup();
        if (success) {
          const formattedDate = now.toLocaleString("en-AU", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          });
          localStorage.setItem(LAST_BACKUP_KEY, formattedDate);
        }
        return;
      }

      const lastBackupDate = new Date(lastBackupStr);

      if (now - lastBackupDate >= BACKUP_INTERVAL) {
        console.log(
          `Last backup was at ${lastBackupStr}, performing new backup...`
        );
        const success = await performAutoBackup();
        if (success) {
          const formattedDate = now.toLocaleString("en-AU", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          });
          localStorage.setItem(LAST_BACKUP_KEY, formattedDate);
        }
      } else {
        console.log(
          `Last backup was at ${lastBackupStr}, next backup in ${Math.round(
            (BACKUP_INTERVAL - (now - lastBackupDate)) / 1000 / 60
          )} minutes`
        );
      }

      if (localStorage.getItem(AUTO_BACKUP_KEY)) {
        if (autoBackupInterval) {
          clearInterval(autoBackupInterval);
        }
        autoBackupInterval = setInterval(performAutoBackup, BACKUP_INTERVAL);
      }
    }

    async function initializeApp() {
      console.log("Initializing app...");

      const backupConfig = localStorage.getItem(AUTO_BACKUP_KEY);
      const lastBackupTime = localStorage.getItem(LAST_BACKUP_KEY);

      cleanupCompletedTodos();
      renderProjects();
      updateTopMenu();

      if (appData.length > 0) {
        const lastBackupDate = lastBackupTime
          ? new Date(
            lastBackupTime.replace(
              /(\d{2})\/(\d{2})\/(\d{4}), (\d{2}:\d{2}:\d{2})/,
              "$3-$2-$1T$4"
            )
          )
          : null;
        const now = new Date();

        if (
          !lastBackupDate ||
          now.getTime() - lastBackupDate.getTime() > 60 * 60 * 1000
        ) {
          nudgeBackup();
        } else {
          const timeUntilNextNudge =
            60 * 60 * 1000 - (now.getTime() - lastBackupDate.getTime());
          setTimeout(nudgeBackup, timeUntilNextNudge);
        }
      }

      if (backupConfig) {
        localStorage.setItem(AUTO_BACKUP_KEY, backupConfig);
      }
      if (lastBackupTime) {
        localStorage.setItem(LAST_BACKUP_KEY, lastBackupTime);
      }

      cleanupInvalidDates();

      if (backupConfig) {
        console.log(
          "Found existing backup configuration, checking backup status..."
        );
        try {
          const lastBackupStr = localStorage.getItem(LAST_BACKUP_KEY);
          if (!lastBackupStr) {
            console.log(
              "No previous backup timestamp found, scheduling reminder..."
            );
            scheduleBackupReminder();
            return;
          }

          const now = new Date();
          const lastBackupDate = parseDateString(lastBackupStr);

          if (isNaN(lastBackupDate.getTime()) || lastBackupDate > now) {
            console.log(
              "Invalid or future backup date detected, scheduling reminder..."
            );
            scheduleBackupReminder();
            return;
          }

          const timeSinceLastBackup = now - lastBackupDate;
          if (timeSinceLastBackup >= BACKUP_INTERVAL) {
            console.log("Backup interval exceeded, scheduling reminder...");
            scheduleBackupReminder();
          } else {
            const nextBackupIn = BACKUP_INTERVAL - timeSinceLastBackup;
            console.log(
              `Next backup in ${Math.round(nextBackupIn / 1000 / 60)} minutes`
            );
            setTimeout(scheduleBackupReminder, nextBackupIn);
          }
        } catch (err) {
          console.error("Error during backup check:", err);
          scheduleBackupReminder();
        }
      }

      initTutorial();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializeApp);
    } else {
      initializeApp();
    }

    function cleanupInvalidDates() {
      const lastBackupStr = localStorage.getItem(LAST_BACKUP_KEY);
      if (!lastBackupStr) return;

      try {
        const [datePart, timePart] = lastBackupStr.split(", ");
        const [day, month, year] = datePart.split("/");
        const [hours, minutes, seconds] = timePart.split(":");

        const lastBackupDate = new Date(
          parseInt(year),
          parseInt(month) - 1,
          parseInt(day),
          parseInt(hours),
          parseInt(minutes),
          parseInt(seconds)
        );

        const now = new Date();

        now.setHours(now.getHours() + 1);

        if (isNaN(lastBackupDate.getTime()) || lastBackupDate > now) {
          console.log("Invalid backup date detected:", {
            lastBackupStr,
            parsed: lastBackupDate,
            now: now,
          });
          localStorage.removeItem(LAST_BACKUP_KEY);
        }
      } catch (err) {
        console.error("Error parsing backup date:", err);
      }
    }

    function checkStorageIntegrity() {
      console.log("Checking storage integrity...");

      const backupConfig = localStorage.getItem(AUTO_BACKUP_KEY);
      const lastBackupTime = localStorage.getItem(LAST_BACKUP_KEY);

      if (backupConfig && !lastBackupTime) {
        console.log(
          "Backup config exists but last backup time is missing. Resetting backup config."
        );
        localStorage.removeItem(AUTO_BACKUP_KEY);
      }

      if (lastBackupTime && !backupConfig) {
        console.log(
          "Last backup time exists but backup config is missing. Clearing last backup time."
        );
        localStorage.removeItem(LAST_BACKUP_KEY);
      }
    }

    checkStorageIntegrity();

    function parseDateString(dateStr) {
      try {
        const [datePart, timePart] = dateStr.split(", ");
        const [day, month, year] = datePart.split("/");
        const [hours, minutes, seconds] = timePart.split(":");

        return new Date(
          parseInt(year),
          parseInt(month) - 1,
          parseInt(day),
          parseInt(hours),
          parseInt(minutes),
          parseInt(seconds)
        );
      } catch (err) {
        console.error("Error parsing date string:", err);
        return new Date(NaN);
      }
    }

    function cleanupCompletedTodos() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let cleanupPerformed = false;

      appData.forEach((project) => {
        project.lists.forEach((list) => {
          if (list.items) {
            const originalLength = list.items.length;
            list.items = list.items.filter((item) => {
              if (!item) return false;
              if (item.type !== "todo") return true;
              if (!item.completed) return true;

              if (item.completedAt) {
                const completionDate = new Date(item.completedAt);
                return completionDate >= today;
              }
              return true; 
            });
            if (list.items.length < originalLength) cleanupPerformed = true;
          }

          if (list.subLists) {
            list.subLists.forEach((subList) => {
              if (subList.items) {
                const originalLength = subList.items.length;
                subList.items = subList.items.filter((item) => {
                  if (!item) return false;
                  if (item.type !== "todo") return true;
                  if (!item.completed) return true;

                  if (item.completedAt) {
                    const completionDate = new Date(item.completedAt);
                    return completionDate >= today;
                  }
                  return true;
                });
                if (subList.items.length < originalLength) cleanupPerformed = true;
              }
            });
          }
        });
      });

      if (cleanupPerformed) {
        saveData();
        renderProjects();
      }
    }

    function nudgeBackup() {
      const autoBackupBtn = document.getElementById("autoBackupBtn");
      if (
        autoBackupBtn &&
        !autoBackupBtn.classList.contains("backup-nudge")
      ) {
        autoBackupBtn.classList.add("backup-nudge");
        autoBackupBtn.title = "⚠️ Please backup your data!";
        autoBackupBtn.innerHTML = "⚠️ Backup Needed";

        autoBackupBtn.addEventListener(
          "click",
          () => {
            autoBackupBtn.classList.remove("backup-nudge");
            autoBackupBtn.innerHTML = '<i class="fa-solid fa-file-export"></i>';
            setTimeout(nudgeBackup, 60 * 60 * 1000);
          },
          { once: true }
        );
      }
    }

    document.addEventListener("DOMContentLoaded", addHistoryStyles);

    function renderSingleProject(project) {
      const projectIndex = appData.findIndex(p => p.id === project.id);
      if (projectIndex === -1) return;

      const existingProject = Array.from(projectsContainer.children).find(
        el => el.querySelector('.project-header .editable').textContent === project.name
      );
      const currentIndex = Array.from(projectsContainer.children).indexOf(existingProject);

      if (existingProject) {
        if (currentIndex !== projectIndex) {
          const timelineContainer = existingProject.querySelector('.timeline-container');
          const nextSibling = projectsContainer.children[projectIndex] || null;
          projectsContainer.insertBefore(existingProject, nextSibling);
          return;
        }
        
        const timelineContainer = existingProject.querySelector('.timeline-container');
        existingProject.remove();
        
        const newProjectElement = document.createElement('div');
        createProject(project, newProjectElement);
        
        if (timelineContainer) {
          const newTimeline = newProjectElement.querySelector('.timeline-container');
          if (newTimeline) {
            newTimeline.replaceWith(timelineContainer);
          }
        }
        
        const nextSibling = projectsContainer.children[projectIndex] || null;
        projectsContainer.insertBefore(newProjectElement, nextSibling);
        return;
      }

      const newProjectElement = document.createElement('div');
      createProject(project, newProjectElement);
      const nextSibling = projectsContainer.children[projectIndex] || null;
      projectsContainer.insertBefore(newProjectElement, nextSibling);
    }

    function addHistoryStyles() {
      const style = document.createElement('style');
      style.textContent = `
        .truncated-text,
        .full-text {
          display: inline;
        }

        .history-table td {
          word-break: break-word;
          line-height: 1.4;
          vertical-align: top;
          padding: 12px 8px;
        }

        .history-table .read-more-btn {
          background: none;
          border: none;
          color: #0066cc;
          cursor: pointer;
          padding: 2px 5px;
          font-size: 0.9em;
          margin-left: 5px;
        }

        .history-table .read-more-btn:hover {
          text-decoration: underline;
        }
      `;
      document.head.appendChild(style);
    }

    function initTutorial() {
      if (localStorage.getItem('tutorialShown')) {
        return;
      }

      if (appData.length === 0) {
        const sampleProject = {
          id: Date.now(),
          name: "My First Project",
          lists: [
            {
              id: Date.now() + 1,
              name: "To Do",
              items: [
                {
                  id: Date.now() + 2,
                  type: "todo",
                  content: "Try dragging this task to another list!",
                  completed: false
                }
              ]
            },
            {
              id: Date.now() + 3,
              name: "In Progress",
              items: []
            },
            {
              id: Date.now() + 4,
              name: "Done",
              items: []
            }
          ]
        };
        appData.push(sampleProject);
        saveData();
        renderProjects();
      }

      setTimeout(() => {
        const intro = introJs();
        
        intro.setOptions({
          steps: [
            {
              title: 'Welcome to Taskan! 👋',
              intro: "Taskan is a simple and easy to use task manager that helps you stay on top of your tasks. Taskan is an offline only app that stores your data locally on your device making it secure and private. You can export your data and import it in another device. Let's take a quick tour to help you get started with organizing your tasks.",
              tooltipClass: 'hide-back-button welcome-step'
            },
            {
              element: '#addProjectBtn',
              title: 'Create Projects',
              intro: 'Start by creating a new project. You can define the timeline here.',
              position: 'bottom'
            },
            {
              element: '.project:first-child .add-list-btn',
              title: 'Add Lists',
              intro: 'Within each project, you can create multiple lists to organize your tasks.',
              position: 'left'
            },
            {
              element: '.list:first-child button[title="Add Sub-list',
              title: 'Sub Lists',
              intro: 'You can add a sub list inside a list to further group tasks.',
              position: 'right'
            },
            {
              element: '.list:first-child button[title="New Todo"]',
              title: 'Add Tasks',
              intro: 'Add todos or notes to your lists. You can track time, set due dates, and more!',
              position: 'left'
            },
            {
              element: '.list-items .list-item:first-child',
              title: 'Manage Tasks',
              intro: 'Drag and drop tasks between lists, edit them, track time, or mark them as complete.',
              position: 'right'
            },
            {
              element: '.list-items .list-item:first-child',
              title: 'Task Options',
              intro: 'Hover over a task to see options for editing, timing, coloring, and more.',
              position: 'right'
            },
            {
              element: '#themeToggleBtn',
              title: 'Customize',
              intro: 'Switch between light and dark themes for comfortable viewing.',
              position: 'bottom'
            },
            {
              element: '#autoBackupBtn',
              title: 'Keep Your Data Safe',
              intro: 'Export your data regularly to keep your tasks backed up.',
              position: 'bottom'
            },
            {
              element: '#importDataBtn',
              title: 'Import Data',
              intro: 'Import your data from a backup file.',
              position: 'bottom'
            },
            {
              title: 'Ready to Go! 🚀',
              intro: "That's it! You're ready to start organizing your tasks. Need help? Look for tooltips when hovering over buttons."
            }
          ],
          showProgress: true,
          showBullets: false,
          disableInteraction: false,
          hideNext: false,
          hidePrev: false,
          exitOnOverlayClick: false,
          exitOnEsc: false,
          skipLabel: '×',
          tooltipClass: 'custom-tooltip',
          onbeforechange: function(targetElement) {
            setTimeout(() => {
              const prevButton = document.querySelector('.introjs-prevbutton');
              if (prevButton) {
                prevButton.style.display = this._currentStep === 0 ? 'none' : 'inline-block';
              }
            }, 0);
          }
        });

        const style = document.createElement('style');
        style.textContent = `
          .introjs-tooltip {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          }
          
          .introjs-button {
            background-color: #555555;
            color: white;
            border: none;
            border-radius: 4px;
            text-shadow: none;
            padding: 6px 12px;
          }
          
          .introjs-button:hover {
            background-color: #000;
            color: white;
          }
          
          [data-theme="dark"] .introjs-button:hover {
            background-color: #666;
          }
          
          .introjs-skipbutton {
            color: var(--text-color);
          }
          
          .introjs-progress {
            background-color: var(--border-color);
          }
          
          .introjs-progressbar {
            background-color: #555555;
          }
          
          .introjs-overlay {
            backdrop-filter: blur(10px);
            background-color: rgba(0, 0, 0, 0.5);
          }
          
          .introjs-helperLayer {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(0);
          }
          
          .introjs-helperLayer::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 12px;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
            z-index: -1;
          }
          
          .introjs-tooltiptext {
            color: var(--text-color);
          }
          
          .introjs-tooltip-title {
            color: var(--text-color);
            font-weight: bold;
          }
          
          .hidden-if-no-project {
            opacity: 0.5;
            pointer-events: none;
          }
          
          .hidden-if-no-list {
            opacity: 0.5;
            pointer-events: none;
          }
          
          .hidden-if-no-item {
            opacity: 0.5;
            pointer-events: none;
          }
          
          .introjs-helperLayer,
          .introjs-overlay {
            transition: all 0.3s ease-out !important;
          }
          
          .introjs-tooltip {
            z-index: 999999;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
          }

          .hide-back-button .introjs-prevbutton {
            display: none !important;
          }

          .hide-back-button .introjs-tooltipbuttons {
            text-align: right;
          }
        `;
        document.head.appendChild(style);

        intro.start();
        intro.oncomplete(() => {
          localStorage.setItem('tutorialShown', 'true');
        });

        // Add a flag to track skip button clicks
        let skipButtonClicked = false;

        // Add click handler for skip button
        document.addEventListener('click', function(e) {
          if (e.target.classList.contains('introjs-skipbutton')) {
            skipButtonClicked = true;
          }
        }, true);

        // Update the onexit handler
        intro.onexit(function() {
          if (skipButtonClicked) {
            localStorage.setItem('tutorialShown', 'true');
          }
          skipButtonClicked = false; // Reset the flag
        });
      }, 1000);
    }
  </script>
</body>

</html>